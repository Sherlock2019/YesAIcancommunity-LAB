# YESAICAN LAB .. the place where problems meet solution , panpojnt meets cure , People help people
# Main Application Entry Point

from __future__ import annotations
import html
import json
import os
import re
import hashlib
from datetime import datetime
from pathlib import Path
from typing import Any, Callable, Iterable, List, Optional
from urllib.parse import urlencode, urlparse

import streamlit as st

from services.ui.utils.meta_store import load_json as load_meta_json
from services.ui.utils.style import render_nav_bar_app

# Disable Streamlit telemetry
os.environ.setdefault("STREAMLIT_TELEMETRY_DISABLED", "true")
os.environ.setdefault("STREAMLIT_BROWSER_GATHER_USAGE_STATS", "false")

# Page configuration
st.set_page_config(
    page_title="YESAICAN LAB .. the place where problems meet solution , panpojnt meets cure , People help people",
    page_icon="üéâ",
    layout="wide",
    initial_sidebar_state="collapsed"
)

st.session_state.setdefault("yes_theme", "dark")
auth_user = st.session_state.get("auth_user")

# Hide Streamlit sidebar
st.markdown("""
    <style>
    [data-testid="stSidebar"],
    section[data-testid="stSidebar"],
    div[data-testid="stSidebarNav"],
    nav[data-testid="stSidebarNav"] {
        display: none !important;
        visibility: hidden !important;
    }
    [data-testid="stAppViewContainer"] {
        margin-left: 0 !important;
        padding-left: 0 !important;
    }
    </style>
""", unsafe_allow_html=True)

LIGHT_CSS = """
    <style>
    html, body, .block-container, [data-testid="stAppViewContainer"] {
        background-color: #ffffff !important;
        color: #0f172a !important;
    }
    .block-container {
        max-width: 100% !important;
        padding-left: 2rem !important;
        padding-right: 2rem !important;
    }
    .left-box {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 20px;
        padding: 3rem 2rem;
        color: #0f172a;
        box-shadow: 6px 0 24px rgba(255, 0, 102, 0.1);
        border: 2px solid #ff0066;
        height: fit-content;
    }
    .right-box {
        background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: -6px 0 24px rgba(0, 212, 255, 0.1);
        border: 2px solid #00d4ff;
    }
    .nav-button {
        display: block;
        width: 100%;
        padding: 1rem 1.5rem;
        margin: 0.5rem 0;
        background: linear-gradient(135deg, #ff0066 0%, #ff3366 100%);
        color: white;
        text-decoration: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(255, 0, 102, 0.3);
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }
    .nav-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(255, 0, 102, 0.4);
    }
    .nav-button-blue {
        background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
    }
    .nav-button-blue:hover {
        box-shadow: 0 8px 24px rgba(0, 212, 255, 0.4);
    }
    .hero-title {
        font-size: 42px;
        font-weight: 900;
        color: #ff0066;
        margin-bottom: 0.5rem;
        text-shadow: 0 4px 12px rgba(255, 0, 102, 0.2);
    }
    .hero-subtitle {
        font-size: 20px;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 1.5rem;
    }
    .hero-body-text {
        font-size: 18px;
        line-height: 1.8;
        color: #0f172a;
        margin-bottom: 1.5rem;
    }
    .feature-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 2px solid #ff0066;
        border-radius: 16px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 4px 12px rgba(255, 0, 102, 0.1);
        transition: all 0.3s;
    }
    .feature-card-blue {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        border: 2px solid #00d4ff;
        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2);
    }
    .feature-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(255, 0, 102, 0.2);
    }
    .feature-title {
        font-size: 22px;
        font-weight: 700;
        color: #ff0066;
        margin-bottom: 0.8rem;
    }
    .feature-title-blue {
        color: #00d4ff;
    }
    .feature-text {
        font-size: 16px;
        line-height: 1.8;
        color: #0f172a;
    }
    .feature-text-white {
        color: #e2e8f0;
    }
    .stButton > button {
        border: none !important;
        cursor: pointer;
        padding: 14px 28px !important;
        font-size: 18px !important;
        font-weight: 700 !important;
        border-radius: 14px !important;
        color: #fff !important;
        background: linear-gradient(135deg, #ff0066 0%, #ff3366 100%) !important;
        box-shadow: 0 8px 24px rgba(255, 0, 102, 0.35);
        transition: all 0.3s;
        width: 100%;
    }
    .stButton > button:hover {
        filter: brightness(1.1);
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(255, 0, 102, 0.45) !important;
    }
    ul.feature-list {
        list-style: none;
        padding-left: 0;
    }
    ul.feature-list li {
        padding: 0.5rem 0;
        font-size: 16px;
        line-height: 1.8;
        color: #334155;
    }
    ul.feature-list li:before {
        content: "‚úì ";
        color: #ff0066;
        font-weight: 700;
        margin-right: 0.5rem;
    }
    ul.feature-list-white li {
        color: #e2e8f0;
    }
    ul.feature-list-white li:before {
        color: #00d4ff;
    }
    footer {
        text-align: center;
        padding: 2rem;
        color: #64748b;
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 3rem;
        border-top: 2px solid #e2e8f0;
    }
    </style>
"""

DARK_CSS = """
    <style>
    html, body, .block-container, [data-testid="stAppViewContainer"] {
        background-color: #0f172a !important;
        color: #e2e8f0 !important;
    }
    .block-container {
        max-width: 100% !important;
        padding-left: 2rem !important;
        padding-right: 2rem !important;
    }
    .left-box {
        background: radial-gradient(circle at top left, #0f172a, #1e293b);
        border-radius: 20px;
        padding: 3rem 2rem;
        color: #f1f5f9;
        box-shadow: 6px 0 24px rgba(0,0,0,0.45);
        border: 2px solid #1e293b;
    }
    .right-box {
        background: linear-gradient(180deg, #1e293b, #0f172a);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: -6px 0 24px rgba(0,0,0,0.35);
        border: 2px solid #1e293b;
    }
    .nav-button {
        display: block;
        width: 100%;
        padding: 1rem 1.5rem;
        margin: 0.5rem 0;
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        text-decoration: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        text-align: center;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.6);
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }
    .nav-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 28px rgba(37, 99, 235, 0.5);
    }
    .nav-button-blue {
        background: linear-gradient(135deg, #06b6d4 0%, #0ea5e9 100%);
        box-shadow: 0 6px 18px rgba(8,145,178,0.5);
    }
    .nav-button-blue:hover {
        box-shadow: 0 12px 28px rgba(14, 165, 233, 0.5);
    }
    .hero-title {
        font-size: 42px;
        font-weight: 900;
        color: #f0f9ff;
        margin-bottom: 0.5rem;
        text-shadow: 0 4px 18px rgba(59,130,246,0.6);
    }
    .hero-subtitle {
        font-size: 20px;
        font-weight: 600;
        color: #93c5fd;
        margin-bottom: 1.5rem;
    }
    .hero-body-text {
        font-size: 18px;
        line-height: 1.8;
        color: #e2e8f0;
        margin-bottom: 1.5rem;
    }
    .feature-card {
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 16px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 8px 24px rgba(0,0,0,0.35);
        transition: all 0.3s;
    }
    .feature-card-blue {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        border: 1px solid rgba(14, 165, 233, 0.4);
        box-shadow: 0 8px 24px rgba(14,165,233,0.3);
    }
    .feature-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(0,0,0,0.45);
    }
    .feature-title {
        font-size: 22px;
        font-weight: 700;
        color: #f0abfc;
        margin-bottom: 0.8rem;
    }
    .feature-title-blue {
        color: #67e8f9;
    }
    .feature-text {
        font-size: 16px;
        line-height: 1.8;
        color: #e2e8f0;
    }
    .feature-text-white {
        color: #e2e8f0;
    }
    .stButton > button {
        border: none !important;
        cursor: pointer;
        padding: 14px 28px !important;
        font-size: 18px !important;
        font-weight: 700 !important;
        border-radius: 14px !important;
        color: #fff !important;
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important;
        box-shadow: 0 12px 32px rgba(37, 99, 235, 0.45);
        transition: all 0.3s;
        width: 100%;
    }
    .stButton > button:hover {
        filter: brightness(1.05);
        transform: translateY(-2px);
        box-shadow: 0 16px 36px rgba(37, 99, 235, 0.55) !important;
    }
    ul.feature-list {
        list-style: none;
        padding-left: 0;
    }
    ul.feature-list li {
        padding: 0.5rem 0;
        font-size: 16px;
        line-height: 1.8;
        color: #cbd5f5;
    }
    ul.feature-list li:before {
        content: "‚úì ";
        color: #38bdf8;
        font-weight: 700;
        margin-right: 0.5rem;
    }
    ul.feature-list-white li {
        color: #cbd5f5;
    }
    ul.feature-list-white li:before {
        color: #38bdf8;
    }
    footer {
        text-align: center;
        padding: 2rem;
        color: #94a3b8;
        font-size: 1.1rem;
        font-weight: 600;
        margin-top: 3rem;
        border-top: 1px solid rgba(148,163,184,0.2);
    }
    </style>
"""


PAGES_DIR = Path(__file__).parent / "pages"
LAUNCH_PORT = os.getenv("LAUNCH_PORT") or "8502"
ACRONYM_TOKENS = {
    "ai",
    "ml",
    "hf",
    "kyc",
    "aml",
    "cio",
    "cto",
    "ceo",
    "cfo",
    "ce",
    "api",
    "ops",
    "llm",
    "rex",
    "ui",
    "ux",
    "crm",
    "ev",
}


def _normalize_launch_base(raw_value: Optional[str]) -> str:
    fallback = f"http://localhost:{LAUNCH_PORT}"
    candidate = (raw_value or "").strip()
    if not candidate:
        return fallback
    if not re.match(r"^https?://", candidate):
        candidate = f"http://{candidate}"
    candidate = candidate.rstrip("/")
    parsed = urlparse(candidate)
    if parsed.scheme and parsed.netloc:
        host = f"{parsed.scheme}://{parsed.netloc}"
        if parsed.port is None and LAUNCH_PORT:
            host = f"{host}:{LAUNCH_PORT}"
        return host
    return fallback


def _slugify_page_stem(stem: str) -> str:
    tokens = [token for token in re.split(r"[_\s]+", stem) if token]
    if not tokens:
        return f"/{stem.lower()}"
    normalized: list[str] = []
    for token in tokens:
        lower = token.lower()
        if lower in ACRONYM_TOKENS:
            normalized.append(lower)
        else:
            normalized.append(lower)
    return f"/{'_'.join(normalized)}"


def load_page_slugs(pages_dir: Path) -> dict[str, str]:
    slugs: dict[str, str] = {}
    if not pages_dir.exists():
        return slugs
    for entry in pages_dir.iterdir():
        if not entry.is_file() or entry.suffix != ".py":
            continue
        if entry.name.startswith("_") or ".ok" in entry.name or entry.name.endswith(".bak"):
            continue
        slugs[entry.stem] = _slugify_page_stem(entry.stem)
    return slugs


LAUNCH_BASE_URL = _normalize_launch_base(
    os.getenv("LAUNCH_BASE_URL") or os.getenv("LAUNCH_HOST")
)
CHALLENGE_FORM_BASE_URL = os.getenv(
    "HOW_CAN_AI_HELP_FORM_BASE",
    "http://171.232.109.168:8054/how_can_ai_help",
)
PAGE_SLUGS = load_page_slugs(PAGES_DIR)

PAGE_PLACEHOLDER_TEMPLATE = """import streamlit as st

st.set_page_config(
    page_title="{page_title}",
    page_icon="üóÇÔ∏è",
    layout="wide",
    initial_sidebar_state="collapsed",
)

st.title("{page_title}")
st.info("This placeholder page was auto-created. Update `{file_path}` with real content.")
"""


def _resolve_page_path(page_path: str) -> Path:
    path_obj = Path(page_path)
    if not path_obj.is_absolute():
        path_obj = Path(__file__).parent / path_obj
    return path_obj


def ensure_page_file(page_path: str, title: str | None = None) -> Path | None:
    """Create a placeholder Streamlit page when a referenced page does not exist."""
    if not page_path or not page_path.endswith(".py"):
        return None
    target_path = _resolve_page_path(page_path)
    if target_path.exists():
        return target_path
    target_path.parent.mkdir(parents=True, exist_ok=True)
    page_title = title or target_path.stem.replace("_", " ").title()
    try:
        relative_path = target_path.relative_to(Path(__file__).parent)
    except ValueError:
        relative_path = target_path.name
    target_path.write_text(
        PAGE_PLACEHOLDER_TEMPLATE.format(
            page_title=page_title,
            file_path=relative_path,
        ),
        encoding="utf-8",
    )
    PAGE_SLUGS[target_path.stem] = _slugify_page_stem(target_path.stem)
    return target_path


def ensure_page_file_for_key(page_key: str) -> None:
    if not page_key:
        return
    candidate = f"pages/{page_key}.py"
    ensure_page_file(candidate)


def render_theme_styles():
    css = DARK_CSS if st.session_state.get("yes_theme", "dark") == "dark" else LIGHT_CSS
    st.markdown(css, unsafe_allow_html=True)


render_theme_styles()

BASE_CSS = """
<style>
.quick-access-card {
    margin-top: 1rem;
    margin-bottom: 1.5rem;
    padding: 25px 24px;
    border-radius: 20px;
    border: 1px solid rgba(56,189,248,0.45);
    background: rgba(15,23,42,0.85);
    box-shadow: 0 18px 42px rgba(15,23,42,0.35);
}
.quick-access-card.light {
    background: rgba(248,250,252,0.95);
    border-color: rgba(14,165,233,0.35);
}
.quick-access-card h3 {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 0.35rem;
    color: #f472b6;
}
.quick-access-card p {
    color: rgba(226,232,240,0.85);
    margin-bottom: 1rem;
}
.quick-access-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 1rem;
    margin-top: 0.5rem;
}
@media (max-width: 768px) {
    .quick-access-grid {
        grid-template-columns: 1fr;
    }
}
.quick-access-card .stButton>button {
    width: 100%;
    border: none;
    border-radius: 16px;
    padding: 0.95rem 1rem;
    font-weight: 700;
    font-size: 1rem;
    color: #fff;
    background: linear-gradient(135deg, #ff1b6b, #45caff);
    box-shadow: 0 18px 35px rgba(255,27,107,0.35);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.quick-access-card .stButton>button:hover {
    transform: translateY(-2px);
    box-shadow: 0 22px 45px rgba(69,202,255,0.35);
}
.neon-divider {
    width: 100%;
    height: 2px;
    margin: 1.75rem 0 1.5rem;
    background: linear-gradient(90deg, rgba(15,23,42,0), rgba(56,189,248,0.85), rgba(15,23,42,0));
    box-shadow: 0 0 20px rgba(56,189,248,0.5);
}
.nav-center-wrapper {
    margin-top: 0.5rem;
    border-radius: 22px;
    border: 1px solid rgba(56,189,248,0.35);
    padding: 1.75rem;
    background: linear-gradient(135deg, rgba(2,6,23,0.95), rgba(15,23,42,0.9));
    box-shadow: 0 25px 60px rgba(14,165,233,0.15);
}
.nav-center-wrapper.light {
    background: linear-gradient(135deg, rgba(248,250,252,0.95), rgba(226,232,240,0.95));
    border-color: rgba(14,165,233,0.45);
    box-shadow: 0 20px 50px rgba(15,23,42,0.15);
}
.nav-center-header {
    text-align: center;
    margin-bottom: 1.25rem;
}
.nav-center-header h2 {
    font-size: 32px;
    font-weight: 800;
    color: #00d4ff;
    margin-bottom: 0.3rem;
}
.nav-center-header p {
    color: rgba(226,232,240,0.85);
    margin: 0;
}
.nav-center-wrapper.light .nav-center-header h2 {
    color: #0f172a;
}
.nav-center-wrapper.light .nav-center-header p {
    color: #475569;
}
.nav-command-grid {
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
}
.nav-mini-block {
    border-radius: 16px;
    padding: 0.25rem;
    background: rgba(15,23,42,0.4);
    box-shadow: inset 0 0 15px rgba(14,165,233,0.12);
}
.nav-center-wrapper.light .nav-mini-block {
    background: rgba(248,250,252,0.8);
}
.nav-mini-block .stButton>button {
    width: 100%;
    border-radius: 14px;
    border: 1px solid rgba(248,113,143,0.65);
    background: linear-gradient(135deg, #ff0a8a, #ff4d4d);
    color: #fff;
    font-weight: 700;
    font-size: 1.05rem;
    padding: 0.85rem 1rem;
    box-shadow: 0 18px 36px rgba(255,77,109,0.4);
    transition: all 0.2s ease;
}
.nav-mini-block .stButton>button:hover {
    transform: translateY(-2px);
    box-shadow: 0 25px 45px rgba(255,77,109,0.45);
}
.nav-mini-desc {
    margin-top: 0.35rem;
    font-size: 0.9rem;
    color: rgba(226,232,240,0.8);
}
.nav-center-wrapper.light .nav-mini-desc {
    color: #475569;
}
.nav-bottom-grid {
    margin-top: 2.5rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.25rem;
}
.challenge-form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}
.challenge-form-card {
    border: 1px solid rgba(59,130,246,0.35);
    border-radius: 18px;
    padding: 1.25rem;
    background: rgba(15,23,42,0.85);
    box-shadow: 0 18px 36px rgba(15,23,42,0.35);
}
.challenge-form-card.light {
    background: #ffffff;
    border-color: rgba(59,130,246,0.25);
    box-shadow: 0 10px 24px rgba(15,23,42,0.15);
}
.challenge-form-card h4 {
    margin-bottom: 0.35rem;
    color: #f472b6;
}
.challenge-form-meta {
    font-size: 0.9rem;
    color: rgba(148,163,184,0.9);
    margin-bottom: 0.5rem;
}
.challenge-form-card.light .challenge-form-meta {
    color: #475569;
}
.challenge-attachment-list {
    list-style: none;
    padding-left: 0;
    margin-bottom: 0.5rem;
}
.challenge-attachment-list li {
    font-size: 0.83rem;
    color: rgba(148,163,184,0.9);
}
.challenge-form-card.light .challenge-attachment-list li {
    color: #475569;
}
.challenge-form-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
}
.challenge-form-actions a {
    flex: 1;
    text-align: center;
    padding: 0.55rem 0.75rem;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.95rem;
}
.challenge-form-actions .primary {
    background: linear-gradient(135deg, #f43f5e, #ec4899);
    color: white;
}
.challenge-form-actions .secondary {
    background: rgba(59,130,246,0.18);
    color: #93c5fd;
}
.challenge-form-card.light .challenge-form-actions .secondary {
    background: rgba(59,130,246,0.08);
    color: #2563eb;
}
.nav-bottom-card {
    border: 1px solid rgba(148,163,184,0.25);
    border-radius: 16px;
    padding: 1.25rem;
    background: rgba(15,23,42,0.7);
    color: rgba(226,232,240,0.85);
    box-shadow: inset 0 0 14px rgba(148,163,184,0.2);
}
.neon-table {
    margin-top: 1.2rem;
    border-radius: 18px;
    border: 1px solid rgba(14,165,233,0.45);
    background: rgba(5,13,26,0.95);
    box-shadow: 0 25px 60px rgba(14,165,233,0.15), inset 0 0 25px rgba(14,165,233,0.1);
    padding: 1.25rem 1.5rem;
    animation: fadeInNeon 0.45s ease;
}
.neon-table.light {
    background: rgba(248,250,252,0.95);
    border-color: rgba(14,165,233,0.4);
    box-shadow: 0 20px 50px rgba(15,23,42,0.15);
}
.neon-table-title {
    font-size: 1.15rem;
    font-weight: 700;
    color: #7dd3fc;
    margin-bottom: 0.75rem;
    letter-spacing: 0.5px;
}
.neon-table.light .neon-table-title {
    color: #2563eb;
}
.neon-table-grid {
    display: grid;
    gap: 0;
    align-items: stretch;
}
.neon-table-header {
    background: linear-gradient(90deg, rgba(14,165,233,0.8), rgba(59,130,246,0.8));
    color: #f8fafc;
    border-radius: 12px;
    margin-bottom: 0.65rem;
    box-shadow: 0 10px 30px rgba(14,165,233,0.35);
}
.neon-table-cell {
    padding: 0.75rem 0.65rem;
    font-size: 0.95rem;
    color: rgba(226,232,240,0.95);
    border-right: 1px solid rgba(15,23,42,0.4);
    word-break: break-word;
    min-height: 52px;
    display: flex;
    align-items: center;
}
.neon-table-cell:last-child {
    border-right: none;
}
.neon-table.light .neon-table-cell {
    color: #0f172a;
    border-right: 1px solid rgba(148,163,184,0.35);
}
.neon-table-row {
    background: rgba(15,23,42,0.75);
    border-radius: 12px;
    margin-bottom: 0.5rem;
    border: 1px solid rgba(59,130,246,0.25);
    box-shadow: 0 15px 30px rgba(2,6,23,0.45);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.neon-table-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 18px 35px rgba(59,130,246,0.35);
    border-color: rgba(14,165,233,0.6);
}
.neon-table.light .neon-table-row {
    background: rgba(248,250,252,0.9);
    border-color: rgba(148,163,184,0.35);
}
.neon-table-action {
    display: inline-block;
    padding: 0.45rem 1.1rem;
    border-radius: 999px;
    background: linear-gradient(135deg, #ff0a8a, #ff4d4d);
    color: #fff;
    font-weight: 700;
    text-decoration: none;
    font-size: 0.9rem;
    box-shadow: 0 10px 24px rgba(255,77,109,0.4);
}
.neon-action-secondary {
    display: inline-block;
    margin-top: 0.25rem;
    font-size: 0.85rem;
    color: rgba(148,163,184,0.9);
    text-decoration: none;
}
.neon-table.light .neon-action-secondary {
    color: #475569;
}
.action-stack {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.2rem;
}
.table-tag {
    display: inline-block;
    padding: 0.15rem 0.65rem;
    border-radius: 999px;
    font-size: 0.78rem;
    margin-right: 0.3rem;
    margin-bottom: 0.3rem;
    background: rgba(14,165,233,0.15);
    color: #bae6fd;
}
.neon-table.light .table-tag {
    background: rgba(14,165,233,0.15);
    color: #0369a1;
}
.status-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.2rem 0.75rem;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 700;
    color: #f8fafc;
    background: rgba(59,130,246,0.35);
    border: 1px solid rgba(59,130,246,0.8);
}
.status-badge.success {
    background: rgba(34,197,94,0.35);
    border-color: rgba(34,197,94,0.8);
}
.status-badge.warning {
    background: rgba(250,204,21,0.3);
    border-color: rgba(250,204,21,0.8);
    color: #1f2937;
}
.status-badge.danger {
    background: rgba(248,113,113,0.3);
    border-color: rgba(248,113,113,0.8);
}
.status-badge.info {
    background: rgba(6,182,212,0.35);
    border-color: rgba(6,182,212,0.8);
}
.neon-table-empty {
    padding: 1rem;
    text-align: center;
    color: rgba(226,232,240,0.7);
    font-style: italic;
}
.neon-table.light .neon-table-empty {
    color: #475569;
}
@keyframes fadeInNeon {
    from {
        opacity: 0;
        transform: translateY(6px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
"""

st.markdown(BASE_CSS, unsafe_allow_html=True)
render_nav_bar_app(show_nav_buttons=False)


def go_to_page(page_path: str) -> None:
    """Navigate to another app page safely."""
    if page_path.endswith(".py"):
        ensure_page_file(page_path)
    try:
        st.switch_page(page_path)
    except Exception as exc:
        st.warning(f"Unable to open {page_path}: {exc}")


def render_section_link(description: str, page: str, button_label: str) -> None:
    st.markdown(f"<p class='nav-section-description'>{description}</p>", unsafe_allow_html=True)
    if st.button(button_label, key=f"nav_btn_{button_label}"):
        go_to_page(page)


def render_quick_access(auth_user: dict | None, origin: str = "default") -> None:
    card_class = "quick-access-card"
    if st.session_state.get("yes_theme", "dark") != "dark":
        card_class += " light"
    st.markdown(f"<div class='{card_class}'>", unsafe_allow_html=True)
    st.markdown("<h3>‚ö° Quick Access</h3><p>Primary launchpad for profiles, projects, agents, and global search.</p>", unsafe_allow_html=True)
    actions = [
        ("üë§ Create Profile", "pages/human_stack.py"),
        ("üß± Submit Project", "pages/project_hub.py"),
        ("ü§ñ Add Agent", "pages/agent_library.py"),
        ("üîç Search All", "pages/search.py"),
    ]
    rows = [actions[i : i + 2] for i in range(0, len(actions), 2)]
    for idx, row in enumerate(rows):
        cols = st.columns(2)
        for col, (label, path) in zip(cols, row):
            with col:
                if st.button(label, key=f"qa_{origin}_{label}_{idx}_{path}", use_container_width=True):
                    go_to_page(path)
    st.markdown("</div>", unsafe_allow_html=True)
    st.markdown("<div class='neon-divider'></div>", unsafe_allow_html=True)


def render_primary_navigation_buttons() -> None:
    st.markdown("### üîó Page Shortcuts")
    nav_items = [
        ("üë§ Human Stack", "pages/human_stack.py", "See every profile, skill, and SME."),
        ("üìÅ Project Hub", "pages/project_hub.py", "Review prototypes and MVPs."),
        ("üß© Challenge Hub", "pages/challenge_hub.py", "Submit challenges, upload attachments, and track signals."),
        ("ü§ù Submit Solution", "pages/solution_submit.py", "Select a challenge and add your AI blueprint."),
        ("ü§ñ Production Ready Agent Library", "pages/agent_library.py", "From Customer ZERO to Customer One agents."),
        ("üß† Ontology & Patterns", "pages/ontology_patterns.py", "Reusable logic + frameworks."),
        ("üìö Docs & Learning", "pages/documentation_learning.py", "Guides, tutorials, learning paths."),
        ("üåç Community & Ambassadors", "pages/community_ambassadors.py", "Badges, cohorts, contributors."),
        ("‚öôÔ∏è Admin & REX 2.0", "pages/admin_rex.py", "Ops telemetry and exports."),
        ("üîç Global Search", "pages/search.py", "Unified search across everything."),
        ("üî• How Can AI Help?", "pages/how_can_ai_help.py", "Submit or solve real challenges."),
    ]
    for label, path, desc in nav_items:
        if st.button(label, key=f"primary_nav_{label}"):
            go_to_page(path)
        st.caption(desc)


def render_form_navigation_buttons() -> None:
    st.markdown("### üß≠ Jump into Forms & Workspaces")
    actions = [
        ("üî• Submit a Challenge", "pages/how_can_ai_help.py", "Share a workflow or customer pain point in the How Can AI Help? intake form."),
        ("üß© Add Proposed Solution", "pages/how_can_ai_help.py", "Scroll to the solution form to capture your AI approach."),
        ("üß± Submit a Project", "pages/project_hub.py", "Publish prototypes, MVPs, and Customer ONE builds."),
        ("üöÄ Convert to Project", "pages/project_hub.py", "Open Project Hub to transform approved challenges into projects."),
        ("üë§ Create / Update Profile", "pages/human_stack.py", "Maintain your Human Stack card so teammates can find you."),
        ("ü§ñ Add or Launch Agent", "pages/agent_library.py", "Register agent builds or launch production-ready copilots."),
        ("üîê Login / My Space", "pages/login_portal.py", "Access your saved submissions and private workspace."),
    ]
    for idx in range(0, len(actions), 2):
        row = actions[idx : idx + 2]
        cols = st.columns(len(row))
        for col, (label, page, desc) in zip(cols, row):
            with col:
                if st.button(label, key=f"form_nav_{slugify_label(label)}", use_container_width=True):
                    go_to_page(page)
                st.caption(desc)


SAMPLE_HELP_SUBMISSIONS = [
    {
        "title": "Sync RAX billing with customer billing format",
        "submitter": {
            "name": "Jon",
            "department": "Billing",
            "region": "APAC",
            "role": "Billing Ops",
        },
        "description": "Need a formatter that aligns any customer-specific billing layout to the Rackspace billing schema automatically.",
        "attachments": [],
        "category": "Finance",
        "difficulty": "Easy",
        "impact": "Medium",
        "task_type": ["Automation"],
        "confidentiality": "Internal",
        "upvotes": 0,
        "comments": 0,
        "urgency": 6.0,
        "impact_score": 6.5,
        "similar_agents": ["Credit Appraisal Agent"],
        "preferred_action": "both",
    },
    {
        "title": "Automate Monthly Billing Reconciliation",
        "submitter": {
            "name": "Jordan Lee",
            "department": "Finance Ops",
            "region": "AMER",
            "role": "Billing Analyst",
        },
        "description": "Manual spreadsheet matching for 12 regions. Need AI to reconcile invoices vs. ERP exports.",
        "attachments": ["billing_rules.pdf", "ledger.csv"],
        "category": "Finance",
        "difficulty": "Medium",
        "impact": "High",
        "task_type": ["Repetitive", "Document-heavy"],
        "confidentiality": "Internal",
        "upvotes": 42,
        "comments": 9,
        "urgency": 8.7,
        "impact_score": 9.2,
        "similar_agents": ["Credit Appraisal Agent"],
        "preferred_action": "convert",
    },
    {
        "title": "Predict Ticket Escalations for Managed Cloud",
        "submitter": {
            "name": "Sasha Ortiz",
            "department": "Customer Support",
            "region": "EMEA",
            "role": "Support Lead",
        },
        "description": "Need AI triage to flag noisy tickets + propose workflows before hitting L3.",
        "attachments": ["ticket_export.csv"],
        "category": "Support",
        "difficulty": "Hard",
        "impact": "Critical",
        "task_type": ["Data-heavy", "Customer-facing"],
        "confidentiality": "Public",
        "upvotes": 58,
        "comments": 14,
        "urgency": 9.5,
        "impact_score": 8.9,
        "similar_agents": ["IT Troubleshooter Agent"],
        "preferred_action": "open",
    },
    {
        "title": "OpenStack Deployment Readiness Validator",
        "submitter": {
            "name": "James O‚ÄôDonnell",
            "department": "Cloud Infra",
            "region": "EMEA",
            "role": "Engineering Lead",
        },
        "description": "Create an automated validator that ingests deployment logs and flags blockers before change windows.",
        "attachments": ["readiness_logs.tar.gz"],
        "category": "Engineering",
        "difficulty": "Hard",
        "impact": "Critical",
        "task_type": ["Automation", "Infra"],
        "confidentiality": "Internal",
        "upvotes": 62,
        "comments": 12,
        "urgency": 9.7,
        "impact_score": 9.1,
        "similar_agents": ["Infra Validator Agent"],
        "preferred_action": "open",
    },
    {
        "title": "Customer Renewal Risk Insights",
        "submitter": {
            "name": "Laura Chen",
            "department": "Sales Ops",
            "region": "AMER",
            "role": "Sales Strategist",
        },
        "description": "Surface risk signals from renewal notes + CRM data to prioritize customer save motions.",
        "attachments": ["renewal_notes.docx"],
        "category": "Sales",
        "difficulty": "Medium",
        "impact": "High",
        "task_type": ["Document-heavy", "Revenue"],
        "confidentiality": "Internal",
        "upvotes": 34,
        "comments": 11,
        "urgency": 8.1,
        "impact_score": 9.4,
        "similar_agents": ["Sales Copilot Agent"],
        "preferred_action": "convert",
    },
    {
        "title": "Onboarding Ticket Auto-Categorizer",
        "submitter": {
            "name": "Rachel Gomez",
            "department": "HR Ops",
            "region": "AMER",
            "role": "People Ops Lead",
        },
        "description": "Auto-label onboarding requests into policy, hardware, security, or manager actions to reduce handling delays.",
        "attachments": ["onboarding_tasks.csv"],
        "category": "HR",
        "difficulty": "Medium",
        "impact": "High",
        "task_type": ["Workflow", "Classification"],
        "confidentiality": "Internal",
        "upvotes": 28,
        "comments": 6,
        "urgency": 7.9,
        "impact_score": 8.5,
        "similar_agents": ["HR Routing Agent"],
        "preferred_action": "convert",
    },
    {
        "title": "Predict Capacity Exhaustion in Infra",
        "submitter": {
            "name": "Santiago Rivera",
            "department": "Data Center Engineering",
            "region": "LATAM",
            "role": "Infra Reliability Lead",
        },
        "description": "Need proactive alerts for storage/CPU exhaustion so we can rebalance workloads before we breach thresholds.",
        "attachments": ["metrics_export.json"],
        "category": "Engineering",
        "difficulty": "Hard",
        "impact": "Critical",
        "task_type": ["Forecasting", "Automation"],
        "confidentiality": "Internal",
        "upvotes": 77,
        "comments": 20,
        "urgency": 9.6,
        "impact_score": 9.9,
        "similar_agents": ["Capacity Forecast Agent"],
        "preferred_action": "open",
    },
    {
        "title": "Auto-Generate Security Incident Reports",
        "submitter": {
            "name": "Karim Haddad",
            "department": "Security Ops",
            "region": "AMER",
            "role": "SOC Lead",
        },
        "description": "Create compliance-ready incident summaries from SOC event streams without manual reformatting.",
        "attachments": ["soc_events.csv"],
        "category": "Security",
        "difficulty": "Medium",
        "impact": "High",
        "task_type": ["Document-heavy", "Compliance"],
        "confidentiality": "Internal",
        "upvotes": 48,
        "comments": 13,
        "urgency": 8.8,
        "impact_score": 9.3,
        "similar_agents": ["SOC Copilot"],
        "preferred_action": "convert",
    },
    {
        "title": "Reduce Chat Support Handle Time",
        "submitter": {
            "name": "Marco Li",
            "department": "Support",
            "region": "APAC",
            "role": "Chat Ops Lead",
        },
        "description": "Need a copilot that recommends macros + shortens chat resolution time for Tier 1 agents.",
        "attachments": ["chat_transcripts.zip"],
        "category": "Support",
        "difficulty": "Medium",
        "impact": "High",
        "task_type": ["Customer-facing"],
        "confidentiality": "Internal",
        "upvotes": 36,
        "comments": 9,
        "urgency": 8.4,
        "impact_score": 8.7,
        "similar_agents": ["Chat Assist Agent"],
        "preferred_action": "convert",
    },
    {
        "title": "Auto-Extract Partner Contract Data",
        "submitter": {
            "name": "Oliver Grant",
            "department": "Legal Ops",
            "region": "EMEA",
            "role": "Legal Manager",
        },
        "description": "Need clause extraction + reasoning notes from PDFs so legal teams can prep partner packages faster.",
        "attachments": ["partner_contracts.pdf"],
        "category": "Legal",
        "difficulty": "Medium",
        "impact": "Medium",
        "task_type": ["Document-heavy"],
        "confidentiality": "Internal",
        "upvotes": 19,
        "comments": 3,
        "urgency": 7.2,
        "impact_score": 7.9,
        "similar_agents": ["OCR Extractor Agent"],
        "preferred_action": "open",
    },
]

SAMPLE_HELP_SOLUTIONS = [
    {
        "challenge": "Sync RAX billing with customer billing format",
        "author": "Elon Musk",
        "approach": "‚ÄúBilling Rocket Formatter‚Äù ‚Äî rule-driven column matcher + auto-normalizer aligning every customer schema to RAX format.",
        "difficulty": "Easy",
        "upvotes": 11,
        "comments": 2,
        "status": "Draft",
    },
    {
        "challenge": "Automate Monthly Billing Reconciliation",
        "author": "John Lennon",
        "approach": "‚ÄúImagine Ledger‚Äù ‚Äî LLM + deterministic journal matcher that reconciles misaligned entries with reasoning + audit trail.",
        "difficulty": "Medium",
        "upvotes": 51,
        "comments": 12,
        "status": "Prototype",
    },
    {
        "challenge": "Predict Ticket Escalations for Managed Cloud",
        "author": "Paul McCartney",
        "approach": "‚ÄúHelpDesk Harmony‚Äù ‚Äî sentiment trajectory predictor + escalation-sequence classifier trained on chat history.",
        "difficulty": "Hard",
        "upvotes": 67,
        "comments": 16,
        "status": "Prototype",
    },
    {
        "challenge": "OpenStack Deployment Readiness Validator",
        "author": "George Harrison",
        "approach": "‚ÄúHere Comes the Sun Validator‚Äù ‚Äî DAG-based infra readiness checker + anomaly patterns from logs.",
        "difficulty": "Medium",
        "upvotes": 44,
        "comments": 9,
        "status": "Draft",
    },
    {
        "challenge": "Customer Renewal Risk Insights",
        "author": "Ringo Starr",
        "approach": "‚ÄúOctopus‚Äôs Risk Garden‚Äù ‚Äî churn scoring + renewal call summarizer using high-confidence LLM extraction.",
        "difficulty": "Medium",
        "upvotes": 29,
        "comments": 7,
        "status": "Draft",
    },
    {
        "challenge": "Onboarding Ticket Auto-Categorizer",
        "author": "Fei-Fei Li",
        "approach": "Vision-LLM hybrid for classification of onboarding docs + HR workflow routing.",
        "difficulty": "Easy",
        "upvotes": 61,
        "comments": 14,
        "status": "MVP Ready",
    },
    {
        "challenge": "Predict Capacity Exhaustion in Infra",
        "author": "Geoffrey Hinton",
        "approach": "‚ÄúNeural Capacity Oracle‚Äù ‚Äî time-series deep learner predicting exhaustion with early warning signals.",
        "difficulty": "Hard",
        "upvotes": 73,
        "comments": 18,
        "status": "Prototype",
    },
    {
        "challenge": "Auto-Generate Security Incident Reports",
        "author": "Timnit Gebru",
        "approach": "‚ÄúFairSecure Reporter‚Äù ‚Äî bias-aware incident summarizer + compliance-aligned reporting engine.",
        "difficulty": "Medium",
        "upvotes": 46,
        "comments": 11,
        "status": "Draft",
    },
    {
        "challenge": "Reduce Chat Support Handle Time",
        "author": "Andrew Ng",
        "approach": "‚ÄúFastTrack Support Tutor‚Äù ‚Äî intent detector + automatic macro suggestion copilot.",
        "difficulty": "Medium",
        "upvotes": 38,
        "comments": 10,
        "status": "MVP",
    },
    {
        "challenge": "Auto-Extract Partner Contract Data",
        "author": "Richard Feynman",
        "approach": "‚ÄúThe Feynman Extractor‚Äù ‚Äî explainable clause parser that exposes plain-English reasoning steps.",
        "difficulty": "Medium",
        "upvotes": 55,
        "comments": 13,
        "status": "Draft",
    },
]

HOW_CAN_AI_HELP_URL = "http://171.232.109.168:8054/how_can_ai_help"


CHALLENGE_FEED_ROWS = [
    {
        "title": "Sync RAX billing with customer billing format",
        "submitter": {"name": "Jon", "department": "Billing", "region": "APAC"},
        "metadata_display": "Billing ‚Ä¢ APAC ‚Äî Finance",
        "attachments": [],
        "urgency": 6.0,
        "impact_score": 6.5,
        "similar_agents": ["Credit Appraisal Agent"],
        "upvotes": 0,
        "comments": 0,
        "action_display": "AI Can Help ‚Ä¢ Convert",
    },
    {
        "title": "Automate Monthly Billing Reconciliation",
        "submitter": {"name": "Jordan Lee", "department": "Finance Ops", "region": "AMER"},
        "metadata_display": "Finance Ops ‚Ä¢ AMER ‚Äî Finance",
        "attachments": ["billing_rules.pdf", "ledger.csv"],
        "urgency": 8.7,
        "impact_score": 9.2,
        "similar_agents": ["Credit Appraisal Agent"],
        "upvotes": 42,
        "comments": 9,
        "action_display": "Convert",
    },
    {
        "title": "Predict Ticket Escalations for Managed Cloud",
        "submitter": {"name": "Sasha Ortiz", "department": "Customer Support", "region": "EMEA"},
        "metadata_display": "Customer Support ‚Ä¢ EMEA ‚Äî Support",
        "attachments": ["ticket_export.csv"],
        "urgency": 9.5,
        "impact_score": 8.9,
        "similar_agents": ["IT Troubleshooter Agent"],
        "upvotes": 58,
        "comments": 14,
        "action_display": "Open",
    },
    {
        "title": "OpenStack Deployment Readiness Validator",
        "submitter": {"name": "James O'Donnell", "department": "Cloud Infra", "region": "EMEA"},
        "metadata_display": "Cloud Infra ‚Ä¢ EMEA ‚Äî Engineering",
        "attachments": ["readiness_logs.tar.gz"],
        "urgency": 9.7,
        "impact_score": 9.1,
        "similar_agents": ["Infra Validator Agent"],
        "upvotes": 62,
        "comments": 12,
        "action_display": "Open",
    },
    {
        "title": "Customer Renewal Risk Insights",
        "submitter": {"name": "Laura Chen", "department": "Sales Ops", "region": "AMER"},
        "metadata_display": "Sales Ops ‚Ä¢ AMER ‚Äî Sales",
        "attachments": ["renewal_notes.docx"],
        "urgency": 8.1,
        "impact_score": 9.4,
        "similar_agents": ["Sales Copilot Agent"],
        "upvotes": 34,
        "comments": 11,
        "action_display": "Convert",
    },
    {
        "title": "Onboarding Ticket Auto-Categorizer",
        "submitter": {"name": "Rachel Gomez", "department": "HR Ops", "region": "AMER"},
        "metadata_display": "HR Ops ‚Ä¢ AMER ‚Äî People",
        "attachments": ["onboarding_tasks.csv"],
        "urgency": 7.9,
        "impact_score": 8.5,
        "similar_agents": ["HR Routing Agent"],
        "upvotes": 28,
        "comments": 6,
        "action_display": "Convert",
    },
    {
        "title": "Predict Capacity Exhaustion in Infra",
        "submitter": {"name": "Santiago Rivera", "department": "Data Center Eng", "region": "LATAM"},
        "metadata_display": "Data Center Eng ‚Ä¢ LATAM",
        "attachments": ["metrics_export.json"],
        "urgency": 9.6,
        "impact_score": 9.9,
        "similar_agents": ["Capacity Forecast Agent"],
        "upvotes": 77,
        "comments": 20,
        "action_display": "Open",
    },
    {
        "title": "Auto-Generate Security Incident Reports",
        "submitter": {"name": "Karim Haddad", "department": "Security Ops", "region": "AMER"},
        "metadata_display": "Security Ops ‚Ä¢ AMER",
        "attachments": ["soc_events.csv"],
        "urgency": 8.8,
        "impact_score": 9.3,
        "similar_agents": ["SOC Copilot"],
        "upvotes": 48,
        "comments": 13,
        "action_display": "Convert",
    },
    {
        "title": "Reduce Chat Support Handle Time",
        "submitter": {"name": "Marco Li", "department": "Support", "region": "APAC"},
        "metadata_display": "Support ‚Ä¢ APAC",
        "attachments": ["chat_transcripts.zip"],
        "urgency": 8.4,
        "impact_score": 8.7,
        "similar_agents": ["Chat Assist Agent"],
        "upvotes": 36,
        "comments": 9,
        "action_display": "Convert",
    },
    {
        "title": "Auto-Extract Partner Contract Data",
        "submitter": {"name": "Oliver Grant", "department": "Legal Ops", "region": "EMEA"},
        "metadata_display": "Legal Ops ‚Ä¢ EMEA",
        "attachments": ["partner_contracts.pdf"],
        "urgency": 7.2,
        "impact_score": 7.9,
        "similar_agents": ["OCR Extractor Agent"],
        "upvotes": 19,
        "comments": 3,
        "action_display": "Open",
    },
]


def _build_sample_submission_lookup() -> dict[str, dict]:
    lookup: dict[str, dict] = {}
    for record in SAMPLE_HELP_SUBMISSIONS:
        title = str(record.get("title", "")).strip().lower()
        if title:
            lookup[title] = record
    return lookup


SAMPLE_SUBMISSION_LOOKUP = _build_sample_submission_lookup()


def find_sample_submission(title: str | None) -> dict | None:
    if not title:
        return None
    return SAMPLE_SUBMISSION_LOOKUP.get(title.strip().lower())


PROPOSED_SOLUTION_ROWS = [
    {
        "challenge": "Sync RAX billing with customer billing format",
        "submitter": "Jon",
        "helper": "Elon Musk",
        "approach": "‚ÄúBilling Rocket Formatter‚Äù ‚Äî rule-driven column matcher + auto-normalizer that aligns any customer billing schema to RAX format",
        "difficulty": "Easy",
        "upvotes": 11,
        "comments": 2,
        "status": "Draft",
    },
    {
        "challenge": "Automate Monthly Billing Reconciliation",
        "submitter": "Jordan Lee",
        "helper": "John Lennon",
        "approach": "‚ÄúImagine Ledger‚Äù ‚Äî LLM + deterministic journal matcher that reconciles mismatched entries using reasoning + audit trace",
        "difficulty": "Medium",
        "upvotes": 51,
        "comments": 12,
        "status": "Prototype",
    },
    {
        "challenge": "Predict Ticket Escalations for Managed Cloud",
        "submitter": "Sasha Ortiz",
        "helper": "Paul McCartney",
        "approach": "‚ÄúHelpDesk Harmony‚Äù ‚Äî sentiment trajectory predictor + escalation-sequence classifier trained on chat history",
        "difficulty": "Hard",
        "upvotes": 67,
        "comments": 16,
        "status": "Prototype",
    },
    {
        "challenge": "OpenStack Deployment Readiness Validator",
        "submitter": "James O‚ÄôDonnell",
        "helper": "George Harrison",
        "approach": "‚ÄúHere Comes the Sun Validator‚Äù ‚Äî DAG-based infra readiness checker + anomaly patterns from logs",
        "difficulty": "Medium",
        "upvotes": 44,
        "comments": 9,
        "status": "Draft",
    },
    {
        "challenge": "Customer Renewal Risk Insights",
        "submitter": "Laura Chen",
        "helper": "Ringo Starr",
        "approach": "‚ÄúOctopus‚Äôs Risk Garden‚Äù ‚Äî churn scoring + renewal call summarizer using high-confidence LLM extraction",
        "difficulty": "Medium",
        "upvotes": 29,
        "comments": 7,
        "status": "Draft",
    },
    {
        "challenge": "Onboarding Ticket Auto-Categorizer",
        "submitter": "Rachel Gomez",
        "helper": "Fei-Fei Li",
        "approach": "Vision-LLM hybrid for classification of onboarding docs + HR workflow routing",
        "difficulty": "Easy",
        "upvotes": 61,
        "comments": 14,
        "status": "MVP Ready",
    },
    {
        "challenge": "Predict Capacity Exhaustion in Infra",
        "submitter": "Santiago Rivera",
        "helper": "Geoffrey Hinton",
        "approach": "‚ÄúNeural Capacity Oracle‚Äù ‚Äî time-series deep learner predicting storage/CPU exhaustion with early warnings",
        "difficulty": "Hard",
        "upvotes": 73,
        "comments": 18,
        "status": "Prototype",
    },
    {
        "challenge": "Auto-Generate Security Incident Reports",
        "submitter": "Karim Haddad",
        "helper": "Timnit Gebru",
        "approach": "‚ÄúFairSecure Reporter‚Äù ‚Äî bias-free incident summarizer + compliance-aligned reporting engine",
        "difficulty": "Medium",
        "upvotes": 46,
        "comments": 11,
        "status": "Draft",
    },
    {
        "challenge": "Reduce Chat Support Handle Time",
        "submitter": "Marco Li",
        "helper": "Andrew Ng",
        "approach": "‚ÄúFastTrack Support Tutor‚Äù ‚Äî intent detector + automatic macro suggestion engine",
        "difficulty": "Medium",
        "upvotes": 38,
        "comments": 10,
        "status": "MVP",
    },
    {
        "challenge": "Auto-Extract Partner Contract Data",
        "submitter": "Oliver Grant",
        "helper": "Richard Feynman",
        "approach": "‚ÄúThe Feynman Extractor‚Äù ‚Äî explainable clause parser that shows reasoning steps in plain English",
        "difficulty": "Medium",
        "upvotes": 55,
        "comments": 13,
        "status": "Draft",
    },
]

DEFAULT_AGENT_CATALOG = [
    (
        "Agent Factory",
        "üß© Agent Builder",
        "üß© Agent Builder",
        "Build custom agents by combining functions from HF and existing agents like LEGO blocks.",
        "Available",
        "üß©",
        True,
        "dzoan.nguyen@rackspace.com",
        "2025-11-27",
        "v1.0.0",
    ),
    (
        "Model Operations",
        "ü§ñ Hugging Face Tools",
        "ü§ñ HF Agent Wrapper",
        "Pure HuggingFace operations ‚Äî Local HF models + HF API. Lightweight, HF-focused solution for all HF tasks.",
        "Available",
        "ü§ñ",
        False,
        "dzoan.nguyen@rackspace.com",
        "2025-11-27",
        "v1.0.0",
    ),
    (
        "Executive Dashboards",
        "üöó Boardroom Intelligence",
        "üöó CEO driver DASHBOARD",
        "Real-time AI cockpit for CEOs to steer revenue, cash, ops, and market moves.",
        "Available",
        "üöó",
        False,
        "dzoan.nguyen@rackspace.com",
        "2025-11-27",
        "v1.0.0",
    ),
    (
        "Retail Banking Suite",
        "Retail Banking Suite",
        "üí¨ Chatbot Assistant",
        "Context-aware embedded assistant.",
        "Available",
        "üí¨",
        False,
        "dzoan.nguyen@rackspace.com",
        "2025-11-27",
        "v1.0.0",
    ),
    (
        "Support & Security",
        "üß† Troubleshooting",
        "üß† IT Troubleshooter Agent",
        "First-principles + case-memory incident solver.",
        "Available",
        "üß†",
        False,
        "dzoan.nguyen@rackspace.com",
        "2025-11-27",
        "v1.0.0",
    ),
]

ALLOWED_AGENT_ROUTE_NAMES = {
    "agent_builder",
    "hf_agent_wrapper",
    "ceo_driver_dashboard",
    "chatbot_assistant",
    "it_troubleshooter_agent",
}


def compute_route_name(agent_label: str) -> str:
    clean = "".join(ch if ch.isalnum() or ch in (" ", "_") else " " for ch in agent_label)
    clean = "_".join(clean.lower().split())
    return clean or "agent"


def load_agent_catalog() -> list[tuple]:
    agents_path = Path(__file__).parent / "data" / "agents.json"
    if agents_path.exists():
        try:
            with open(agents_path, "r", encoding="utf-8") as handle:
                data = json.load(handle)
                catalog = []
                for agent in data:
                    name = agent.get("agent", agent.get("name", "Agent"))
                    route = compute_route_name(name)
                    if route not in ALLOWED_AGENT_ROUTE_NAMES:
                        continue
                    catalog.append(
                        (
                            agent.get("sector", agent.get("industry", "Cross-Industry")),
                            agent.get("industry", agent.get("sector", "")),
                            name,
                            agent.get("description", ""),
                            agent.get("status", "Available"),
                            agent.get("emoji", "ü§ñ"),
                            agent.get("requires_login", False),
                            agent.get("author", "dzoan.nguyen@rackspace.com"),
                            agent.get("created_at", datetime.now().strftime("%Y-%m-%d")),
                            agent.get("version", "v1.0.0"),
                        )
                    )
                if catalog:
                    return catalog
        except Exception:
            pass
    return DEFAULT_AGENT_CATALOG


AGENTS = load_agent_catalog()
CUSTOM_AGENT_LAUNCHES: dict[str, str] = {}


def load_feedback_store() -> dict:
    return load_meta_json("feedback.json", {})


feedback_data = load_feedback_store()


SAMPLE_HUMANS = [
    {
        "name": "John Lennon",
        "department": "Innovation & Strategy",
        "region": "UK / EMEA",
        "skills": ["Creative AI", "Generative Models", "Prompt Artistry", "Vision AI"],
        "contributions": {"projects": 3, "agents": 2},
        "ai_contributions": "3 generative agents (‚ÄúImagineGPT‚Äù), 2 creativity frameworks, 1 RAG music dataset",
        "created_at": "2024-05-01",
        "updated_at": "2025-02-10",
        "sme_level": "‚≠ê‚≠ê‚≠ê‚≠ê Expert",
    },
    {
        "name": "Paul McCartney",
        "department": "Customer Experience & Solutions",
        "region": "UK / EMEA",
        "skills": ["Voice AI", "Multimodal ML", "Human-AI Interaction"],
        "contributions": {"projects": 4, "agents": 2},
        "ai_contributions": "4 voice-cloning demos, 2 sentiment-analysis agents, 1 ‚ÄúHey Jude AI Assistant‚Äù",
        "created_at": "2024-04-12",
        "updated_at": "2025-02-08",
        "sme_level": "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Principal",
    },
    {
        "name": "George Harrison",
        "department": "Engineering & Automation",
        "region": "APAC",
        "skills": ["Workflow Automation", "Agent Orchestration", "Calm Design"],
        "contributions": {"projects": 3, "agents": 2},
        "ai_contributions": "2 automation agents (‚ÄúHere Comes the Flow‚Äù), 3 AI-integrated pipelines",
        "created_at": "2024-03-05",
        "updated_at": "2025-01-15",
        "sme_level": "‚≠ê‚≠ê‚≠ê Skilled",
    },
    {
        "name": "Ringo Starr",
        "department": "Support & Operations",
        "region": "AMER",
        "skills": ["Reliability Engineering", "Monitoring AI", "LLM Guardrails"],
        "contributions": {"projects": 3, "agents": 1},
        "ai_contributions": "3 ops copilots, 1 anomaly detection agent (‚ÄúOctopus‚Äôs Ops Copilot‚Äù)",
        "created_at": "2024-02-10",
        "updated_at": "2024-12-20",
        "sme_level": "‚≠ê‚≠ê Advanced Beginner",
    },
    
    {
        "name": "Yann LeCun",
        "department": "Meta AI",
        "region": "North America",
        "skills": ["Self-Supervised Learning", "Deep Learning", "Autonomy"],
        "contributions": {"projects": 4, "agents": 4},
        "ai_contributions": "Co-inventor of CNNs, global AI research leadership",
        "created_at": "2024-01-01",
        "updated_at": "2025-02-02",
        "sme_level": "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Principal",
    },
    {
        "name": "Demis Hassabis",
        "department": "Google DeepMind",
        "region": "UK / Europe",
        "skills": ["AGI", "Reinforcement Learning", "Model Alignment"],
        "contributions": {"projects": 6, "agents": 5},
        "ai_contributions": "AlphaGo, AlphaFold, frontier model breakthroughs",
        "created_at": "2024-01-05",
        "updated_at": "2025-02-03",
        "sme_level": "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Principal",
    },
   
    {
        "name": "Elon Musk",
        "department": "Tesla / SpaceX / xAI",
        "region": "Global",
        "skills": ["AI Safety", "Robotics", "Simulation", "Autonomy"],
        "contributions": {"projects": 5, "agents": 2},
        "ai_contributions": "Autonomous systems, humanoid robots, xAI Grok",
        "created_at": "2024-05-20",
        "updated_at": "2025-01-02",
        "sme_level": "‚≠ê‚≠ê‚≠ê‚≠ê Expert",
    },
    
]


SAMPLE_PROJECTS = [
    {
        "title": "Renewable Finance Copilot",
        "authors": ["Avery Chen", "Mia Patel"],
        "business_area": "Green Energy",
        "summary": "Forecast capital flows & compliance across global farms.",
        "created_at": "2024-09-02",
        "status": "MVP",
        "upvotes": 18,
        "comments": 6,
    },
    {
        "title": "CX Sentiment Heatmap",
        "authors": ["Lila Moreno"],
        "business_area": "Customer Success",
        "summary": "Streaming sentiment insights for Rackspace customer boards.",
        "created_at": "2024-07-25",
        "status": "Incubation",
        "upvotes": 11,
        "comments": 4,
    },
]

SAMPLE_PATTERNS = [
    {
        "name": "Credit Explainability Pattern",
        "description": "Ensure every credit decision ships with policy rationale + SHAP.",
        "domain": "Finance",
        "use_cases": ["Retail Lending", "SMB Working Capital"],
        "author": "Noor Idris",
        "created_at": "2024-06-15",
    },
    {
        "name": "Global KYC Ontology",
        "description": "Entity + document graph powering AML/KYC orchestration.",
        "domain": "Compliance",
        "use_cases": ["AML", "Sanctions"],
        "author": "Mason Reed",
        "created_at": "2024-05-20",
    },
]

SAMPLE_DOCS = [
    {
        "title": "YES AI CAN Onboarding Playbook",
        "category": "Guide",
        "author": "Rackers Lab PMO",
        "updated_at": "2024-10-01",
        "read_time": "12 min",
        "rating": 4.8,
    },
    {
        "title": "HF Agent Builder Tutorial",
        "category": "Tutorial",
        "author": "Priya Desai",
        "updated_at": "2024-09-10",
        "read_time": "8 min",
        "rating": 4.6,
    },
]

SAMPLE_COMMUNITY = [
    {
        "name": "Noor Idris",
        "department": "FinOps Advisory",
        "region": "APJ",
        "skills": ["FinOps", "Compliance AI"],
        "badges": ["Ambassador L2", "AI Ethics"],
        "contributions": ["Credit Engines", "Policy Pattern"],
        "cohort": "2024A",
    },
    {
        "name": "Diego Ramos",
        "department": "Cloud Operations",
        "region": "LATAM",
        "skills": ["AIOps", "Infra Observability"],
        "badges": ["Community Builder"],
        "contributions": ["AIOps Runbooks"],
        "cohort": "2023B",
    },
]

SAMPLE_ADMIN = [
    {
        "name": "REX Metadata Exporter",
        "description": "Push JSON payloads to REX 2.0 ingestion bucket.",
        "category": "Export",
        "telemetry": "Stable",
        "updated_at": "2024-10-15",
    },
    {
        "name": "Agent Health Monitor",
        "description": "Track API uptime and GPU utilization per agent.",
        "category": "Monitoring",
        "telemetry": "Beta",
        "updated_at": "2024-09-28",
    },
]

SAMPLE_SEARCH = [
    {
        "type": "Profile",
        "title": "Avery Chen",
        "category": "Human Stack",
        "owner": "avery.chen@rackspace",
        "updated_at": "2024-10-12",
    },
    {
        "type": "Agent",
        "title": "Credit Appraisal Agent",
        "category": "Banking",
        "owner": "risk@rackspace",
        "updated_at": "2024-09-30",
    },
    {
        "type": "Pattern",
        "title": "Unified Risk Ontology",
        "category": "Ontology",
        "owner": "ontology@rackspace",
        "updated_at": "2024-08-05",
    },
]


def load_meta_records(filename: str, sample: list[dict]) -> list[dict]:
    try:
        data = load_meta_json(filename, sample)
    except Exception:
        return sample
    if not data:
        return sample
    if isinstance(data, dict):
        for key in ("items", "records", "data"):
            if key in data and isinstance(data[key], list):
                data = data[key]
                break
        else:
            data = [data]
    return data


def format_tags(values: Iterable[str] | None) -> str:
    if not values:
        return "‚Äî"
    if isinstance(values, str):
        values = [values]
    tags = []
    for val in values:
        if val:
            tags.append(f"<span class='table-tag'>{html.escape(str(val))}</span>")
    return "".join(tags) or "‚Äî"


def describe_attachment_list(values: Iterable[Any] | None) -> str:
    if not values:
        return "<ul class='challenge-attachment-list'><li>‚Äî</li></ul>"
    if isinstance(values, str):
        values = [values]
    items: list[str] = []
    for raw in values:
        if isinstance(raw, dict):
            label = raw.get("name") or raw.get("path")
        else:
            label = str(raw)
        if label:
            items.append(f"<li>{html.escape(label)}</li>")
    if not items:
        items.append("<li>‚Äî</li>")
    return f"<ul class='challenge-attachment-list'>{''.join(items)}</ul>"


def build_status_badge(text: str, variant: str = "info") -> str:
    safe = html.escape(text or "‚Äî")
    return f"<span class='status-badge {variant}'>{safe}</span>"


PAGE_SLUGS.update(
    {
        "how_can_ai_help": PAGE_SLUGS.get("how_can_ai_help", "/how_can_ai_help"),
        "human_stack": PAGE_SLUGS.get("human_stack", "/human_stack"),
        "project_hub": PAGE_SLUGS.get("project_hub", "/project_hub"),
    }
)

#new 
def normalize_challenge_row(item: dict) -> list[str]:
    """Build a display-ready row for a submission, ensuring we always show data."""
    try:
        challenge_id = ensure_challenge_anchor(item)
        submitter = item.get("submitter") or {}
        submitter_name = submitter.get("name", "‚Äî")
        department = submitter.get("department", "‚Äî")
        region = submitter.get("region", "‚Äî")
        submitter_text = f"{html.escape(submitter_name)}<br><small>{html.escape(department)} ‚Ä¢ {html.escape(region)}</small>"

        dept_region = " ‚Ä¢ ".join(
            part.strip()
            for part in (str(submitter.get("department", "")), str(submitter.get("region", "")))
            if part and part.strip()
        )
        metadata_lines: list[str] = []
        if dept_region:
            metadata_lines.append(html.escape(dept_region.lower()))
        category = item.get("category")
        if category:
            metadata_lines.append(html.escape(str(category)))
        difficulty = item.get("difficulty")
        if difficulty:
            metadata_lines.append(html.escape(str(difficulty)))
        metadata = "<br>".join(metadata_lines) or "‚Äî"

        attachments = describe_attachment_list(item.get("attachments"))
        social = f"üëç {item.get('upvotes', 0)} ‚Ä¢ üí¨ {item.get('comments', 0)}"
        similar = format_tags(item.get("similar_agents"))

        challenge_launch = build_challenge_form_url(item)
        convert_params = {
            "convert_submission_id": challenge_id,
            "source_submission_id": challenge_id,
            "convert_submission_title": item.get("title"),
            "convert_submission_description": item.get("description"),
            "convert_submission_category": item.get("category"),
            "convert_submission_difficulty": item.get("difficulty"),
            "convert_submission_submitter": submitter.get("name"),
            "convert_submission_department": submitter.get("department"),
            "convert_submission_region": submitter.get("region"),
            "convert_submission_upvotes": item.get("upvotes"),
            "convert_submission_comments": item.get("comments"),
            "convert_submission_urgency": item.get("urgency"),
            "convert_submission_impact": item.get("impact_score"),
        }
        convert_href = build_page_url("project_hub", convert_params)
        convert_launch = ensure_absolute_page_url(convert_href)
        spec_page_key = get_challenge_spec_page(item.get("title"))
        if spec_page_key:
            spec_href = build_page_url(spec_page_key, {"challenge_id": challenge_id})
            spec_launch = ensure_absolute_page_url(spec_href)
            action_html = build_action_triple_stack(
                "AI Can Help",
                challenge_launch,
                "Convert",
                convert_launch,
                "Open",
                spec_launch,
            )
        else:
            action_html = build_action_stack(
                "AI Can Help",
                challenge_launch,
                "Convert",
                convert_launch,
            )

        return [
            html.escape(item.get("title", "‚Äî")),
            submitter_text,
            metadata,
            attachments,
            f"{item.get('urgency', 0):.1f}",
            f"{item.get('impact_score', 0):.1f}",
            similar,
            social,
            action_html,
        ]
    except Exception:
        return ["‚Äî"] * 9



def build_page_url(page_key: str, params: dict[str, Any] | None = None) -> str:
    if page_key not in PAGE_SLUGS:
        ensure_page_file_for_key(page_key)
    if page_key not in PAGE_SLUGS:
        PAGE_SLUGS[page_key] = _slugify_page_stem(page_key)
    base = PAGE_SLUGS.get(page_key)
    if not base:
        base = _slugify_page_stem(page_key)
    if not params:
        return base
    cleaned = {k: v for k, v in params.items() if v not in (None, "", False)}
    if not cleaned:
        return base
    return f"{base}?{urlencode(cleaned, doseq=True)}"


def ensure_absolute_page_url(url: str) -> str:
    if not url:
        return LAUNCH_BASE_URL
    if url.startswith(("http://", "https://")):
        return url
    if url.startswith("/"):
        return f"{LAUNCH_BASE_URL}{url}"
    return f"{LAUNCH_BASE_URL}/{url.lstrip('/')}"


def ensure_solution_anchor(idea: dict) -> str:
    if idea.get("id"):
        return str(idea["id"])
    raw = (
        f"{idea.get('challenge', '')}|"
        f"{idea.get('author', '')}|"
        f"{idea.get('created_at', '')}|"
        f"{(idea.get('approach') or '')[:64]}"
    )
    digest = hashlib.sha1(raw.encode("utf-8", "ignore")).hexdigest()[:10]
    anchor = f"solution_{digest}"
    idea["id"] = anchor
    return anchor


def ensure_challenge_anchor(item: dict) -> str:
    if item.get("id"):
        return str(item["id"])
    submitter = item.get("submitter", {})
    raw = (
        f"{item.get('title', '')}|"
        f"{submitter.get('name', '')}|"
        f"{submitter.get('department', '')}|"
        f"{(item.get('description') or '')[:64]}"
    )
    digest = hashlib.sha1(raw.encode("utf-8", "ignore")).hexdigest()[:10]
    anchor = f"challenge_{digest}"
    item["id"] = anchor
    return anchor


def slugify_label(value: str | None, default: str = "project") -> str:
    if not value:
        return default
    cleaned = re.sub(r"[^0-9a-zA-Z]+", " ", value).strip().lower()
    return "_".join(cleaned.split()) or default


def ensure_project_anchor(item: dict) -> str:
    if item.get("id"):
        return str(item["id"])
    anchor = slugify_label(item.get("title"), "project")
    item["id"] = anchor
    return anchor


def build_challenge_form_url(item: dict) -> str:
    challenge_id = ensure_challenge_anchor(item)
    submitter = item.get("submitter", {}) or {}
    params = {
        "challenge_id": challenge_id,
        "challenge_title": item.get("title"),
        "challenge_description": item.get("description"),
        "challenge_category": item.get("category"),
        "challenge_difficulty": item.get("difficulty"),
        "challenge_urgency": item.get("urgency"),
        "challenge_impact": item.get("impact_score"),
        "submitter_name": submitter.get("name"),
        "submitter_department": submitter.get("department"),
        "submitter_region": submitter.get("region"),
        "submitter_role": submitter.get("role"),
    }
    cleaned = {k: v for k, v in params.items() if v not in (None, "", [])}
    if not cleaned:
        return CHALLENGE_FORM_BASE_URL
    return f"{CHALLENGE_FORM_BASE_URL}?{urlencode(cleaned)}"


def build_action_button(label: str, href: str = "#") -> str:
    return f"<a class='neon-table-action' href='{html.escape(href)}'>{html.escape(label)}</a>"


def build_action_stack(primary: str, href: str, secondary: str = "View", secondary_href: str | None = None) -> str:
    target = secondary_href or href
    return (
        "<div class='action-stack'>"
        f"{build_action_button(primary, href)}"
        f"<a class='neon-action-secondary' href='{html.escape(target)}'>{html.escape(secondary)}</a>"
        "</div>"
    )


def build_action_triple_stack(
    primary: str,
    primary_href: str,
    secondary: str,
    secondary_href: str,
    tertiary: str,
    tertiary_href: str,
) -> str:
    """Render a 3-button stack: primary, secondary, tertiary."""
    return (
        "<div class='action-stack'>"
        f"{build_action_button(primary, primary_href)}"
        f"<a class='neon-action-secondary' href='{html.escape(secondary_href)}'>{html.escape(secondary)}</a>"
        f"<a class='neon-action-secondary' href='{html.escape(tertiary_href)}'>{html.escape(tertiary)}</a>"
        "</div>"
    )


def build_challenge_action(item: dict, help_href: str, convert_href: str) -> str:
    mode = str(item.get("preferred_action", "")).lower()
    if mode == "convert":
        return build_action_button("Convert", convert_href)
    if mode == "open":
        return build_action_button("Open", help_href)
    return build_action_stack("AI Can Help", help_href, "Convert", convert_href)


def render_star_rating(value: float | int | None) -> str:
    try:
        rating = max(0.0, min(5.0, float(value or 0)))
    except (TypeError, ValueError):
        rating = 0.0
    full = int(round(rating))
    stars = "‚òÖ" * full + "‚òÜ" * (5 - full)
    return f"<span>{stars} <small style='color:#94a3b8;'>({rating:.1f})</small></span>"


def format_date(value: str | None) -> str:
    if not value:
        return "‚Äî"
    try:
        dt = datetime.fromisoformat(value.replace("Z", ""))
        return dt.strftime("%Y-%m-%d")
    except ValueError:
        return value[:10]


def render_neon_table(title: str, columns: List[str], rows: List[List[str]], empty_message: str) -> None:
    theme_class = "neon-table"
    if st.session_state.get("yes_theme", "dark") != "dark":
        theme_class += " light"
    col_count = len(columns)
    grid_style = f"grid-template-columns: repeat({col_count}, minmax(140px, 1fr));"
    header_html = "".join(f"<div class='neon-table-cell'>{col}</div>" for col in columns)
    if rows:
        row_blocks = []
        for row in rows:
            cells = "".join(f"<div class='neon-table-cell'>{cell}</div>" for cell in row)
            row_blocks.append(f"<div class='neon-table-grid neon-table-row' style='{grid_style}'>{cells}</div>")
        rows_html = "".join(row_blocks)
    else:
        rows_html = f"<div class='neon-table-empty'>{empty_message}</div>"
    st.markdown(
        f"""
        <div class="{theme_class}">
            <div class="neon-table-title">{title}</div>
            <div class="neon-table-grid neon-table-header" style="{grid_style}">
                {header_html}
            </div>
            {rows_html}
        </div>
        """,
        unsafe_allow_html=True,
    )


def build_placeholder_submission_from_solution(solution: dict) -> dict:
    return {
        "title": solution.get("challenge"),
        "description": solution.get("approach"),
        "submitter": {
            "name": solution.get("helper_submitter") or "‚Äî",
            "department": "",
            "region": "",
        },
        "category": solution.get("category") or "‚Äî",
        "difficulty": solution.get("difficulty", "Medium"),
        "attachments": [],
        "urgency": 0,
        "impact_score": 0,
        "similar_agents": [],
        "upvotes": 0,
        "comments": 0,
        "preferred_action": "open",
    }


def load_matched_challenge_solution_pairs(limit: int = 10) -> list[tuple[dict | None, dict | None]]:
    submissions_source = load_meta_records("how_ai_help_submissions.json", SAMPLE_HELP_SUBMISSIONS)
    solutions_source = load_meta_records("how_ai_help_solutions.json", SAMPLE_HELP_SOLUTIONS)
    title_to_submission: dict[str, dict] = {}
    for submission in submissions_source:
        title = submission.get("title")
        if title:
            title_to_submission[title.strip().lower()] = submission
    pairs: list[tuple[dict | None, dict | None]] = []
    seen_ids: set[str] = set()
    for solution in solutions_source:
        challenge_title = str(solution.get("challenge", "")).strip()
        if not challenge_title:
            continue
        submission = title_to_submission.get(challenge_title.lower())
        if not submission:
            placeholder = build_placeholder_submission_from_solution(solution)
            submission = placeholder
        seen_ids.add(ensure_challenge_anchor(submission))
        pairs.append((submission, solution))
        if len(pairs) >= limit:
            break
    if len(pairs) < limit:
        for submission in submissions_source:
            if ensure_challenge_anchor(submission) in seen_ids:
                continue
            pairs.append((submission, None))
            seen_ids.add(ensure_challenge_anchor(submission))
            if len(pairs) >= limit:
                break
    return pairs[:limit]


def render_help_submission_table() -> list[dict]:
    submissions = CHALLENGE_FEED_ROWS
    rows: list[list[str]] = []
    for item in submissions:
        submitter = item.get("submitter") or {}
        submitter_text = (
            f"{html.escape(submitter.get('name', '‚Äî'))}"
            f"<br><small>{html.escape(submitter.get('department', '‚Äî'))} ‚Ä¢ {html.escape(submitter.get('region', '‚Äî'))}</small>"
        )
        metadata = html.escape(item.get("metadata_display") or "‚Äî")
        attachments = describe_attachment_list(item.get("attachments"))
        social = f"üëç {item.get('upvotes', 0)} ‚Ä¢ üí¨ {item.get('comments', 0)}"
        similar = format_tags(item.get("similar_agents"))
        sample = find_sample_submission(item.get("title"))
        if sample:
            detail_url = ensure_absolute_page_url(build_challenge_form_url(sample))
        else:
            detail_url = HOW_CAN_AI_HELP_URL
        action_html = build_action_button("How Can AI Help", detail_url)
        rows.append(
            [
                html.escape(item.get("title", "‚Äî")),
                submitter_text,
                metadata,
                attachments,
                f"{item.get('urgency', 0):.1f}",
                f"{item.get('impact_score', 0):.1f}",
                similar,
                social,
                action_html,
            ]
        )
    columns = [
        "üìù Challenge",
        "üßç Submitter",
        "üß† Metadata",
        "üìé Attachments",
        "‚ö° Urgency",
        "üéØ Impact",
        "ü§ñ Similar Agents",
        "‚≠ê Signals",
        "üöÄ Action",
    ]
    render_neon_table(
        "üî• TABLE 1 ‚Äî Challenge Feed (Pain Points)",
        columns,
        rows,
        "Fully aligned to the AI Solution list.",
    )
    return submissions


def render_help_solution_table() -> None:
    rows: list[list[str]] = []
    for entry in PROPOSED_SOLUTION_ROWS:
        rows.append(
            [
                html.escape(entry.get("challenge", "‚Äî")),
                html.escape(entry.get("submitter", "‚Äî")),
                html.escape(entry.get("helper", "‚Äî")),
                html.escape(entry.get("approach", "‚Äî")),
                build_status_badge(entry.get("difficulty", "Medium"), "warning"),
                f"üëç {entry.get('upvotes', 0)} ‚Ä¢ üí¨ {entry.get('comments', 0)}",
                build_status_badge(entry.get("status", "Draft"), "info"),
                build_action_button("View Idea", HOW_CAN_AI_HELP_URL),
            ]
        )
    columns = [
        "üìù Challenge",
        "üßç Submitter",
        "ü§ù Helper",
        "üß© Proposed AI Approach",
        "‚öôÔ∏è Difficulty",
        "‚≠ê Signals",
        "üìä Status",
        "üöÄ Action",
    ]
    render_neon_table(
        "üß© TABLE 2 ‚Äî Proposed AI Solutions (Perfectly Matched)",
        columns,
        rows,
        "Every challenge above has a matching solution below.",
    )


def render_challenge_form_cards(challenges: list[dict]) -> None:
    if not challenges:
        return
    st.markdown(
        """
        <div class="neon-table" style="margin-top:1.5rem;">
            <div class="neon-table-title">üßæ Challenge Intake Forms (Mockups)</div>
            <p style="color:rgba(148,163,184,0.9);margin-bottom:0.5rem;">
                Each card opens the dedicated challenge intake workspace with details prefilled from the mock submissions.
            </p>
        </div>
        """,
        unsafe_allow_html=True,
    )
    theme_light = st.session_state.get("yes_theme", "dark") != "dark"
    st.markdown("<div class='challenge-form-grid'>", unsafe_allow_html=True)
    body_color = "#0f172a" if theme_light else "rgba(226,232,240,0.9)"
    signal_color = "#1e293b" if theme_light else "rgba(226,232,240,0.85)"
    for item in challenges:
        submitter = item.get("submitter", {}) or {}
        challenge_launch = build_challenge_form_url(item)
        challenge_href = ensure_absolute_page_url(challenge_launch)
        challenge_id = ensure_challenge_anchor(item)
        convert_params = {
            "convert_submission_id": challenge_id,
            "source_submission_id": challenge_id,
            "convert_submission_title": item.get("title"),
            "convert_submission_description": item.get("description"),
            "convert_submission_category": item.get("category"),
            "convert_submission_difficulty": item.get("difficulty"),
            "convert_submission_submitter": submitter.get("name"),
            "convert_submission_department": submitter.get("department"),
            "convert_submission_region": submitter.get("region"),
            "convert_submission_upvotes": item.get("upvotes"),
            "convert_submission_comments": item.get("comments"),
            "convert_submission_urgency": item.get("urgency"),
            "convert_submission_impact": item.get("impact_score"),
        }
        convert_href = build_page_url("project_hub", convert_params)
        convert_launch = ensure_absolute_page_url(convert_href)
        attachments = describe_attachment_list(item.get("attachments"))
        similar = format_tags(item.get("similar_agents"))
        metadata = (
            f"{build_status_badge(item.get('category', 'General'), 'info')} "
            f"{build_status_badge(item.get('difficulty', 'Medium'), 'warning')}"
        )
        card_class = "challenge-form-card light" if theme_light else "challenge-form-card"
        st.markdown(
            f"""
            <div class="{card_class}">
                <h4>{html.escape(item.get('title', 'Untitled'))}</h4>
                <div class="challenge-form-meta">
                    {html.escape(submitter.get('name', '‚Äî'))} ‚Ä¢ {html.escape(submitter.get('department', '‚Äî'))} ‚Ä¢ {html.escape(submitter.get('region', '‚Äî'))}
                </div>
                <div>{metadata}</div>
                <div style="margin-top:0.5rem;color:{body_color};">{html.escape(item.get('description', '')[:160])}</div>
                {attachments}
                <div style="font-size:0.9rem;color:{signal_color};">
                    ‚ö° {item.get('urgency', 0):.1f} ‚Ä¢ üéØ {item.get('impact_score', 0):.1f} ‚Ä¢ üëç {item.get('upvotes', 0)} ‚Ä¢ üí¨ {item.get('comments', 0)}
                </div>
                <div style="margin-top:0.3rem;">{similar}</div>
                <div class="challenge-form-actions">
                    <a class="primary" href="{challenge_href}" target="_blank">AI Can Help</a>
                    <a class="secondary" href="{convert_launch}" target="_blank">Convert to Project</a>
                </div>
            </div>
            """,
            unsafe_allow_html=True,
        )
    st.markdown("</div>", unsafe_allow_html=True)


def render_project_hub_section() -> None:
    projects = load_meta_records("projects.json", SAMPLE_PROJECTS)
    rows: list[list[str]] = []
    for project in projects[:5]:
        project_id = ensure_project_anchor(project)
        owners = project.get("authors") or project.get("owner_name") or project.get("owner_email")
        if isinstance(owners, (list, tuple, set)):
            owner_text = ", ".join(str(owner) for owner in owners if owner)
        else:
            owner_text = owners or "‚Äî"
        area = project.get("business_area") or project.get("category") or "‚Äî"
        status_value = project.get("phase") or project.get("status") or "Idea"
        status_text = str(status_value)
        status_variant = "success" if status_text.lower() in {"mvp", "launched", "production", "prod"} else "info"
        created = format_date(project.get("created_at"))
        signals = f"üëç {project.get('upvotes', 0)} ‚Ä¢ üí¨ {project.get('comments', 0)}"
        summary = project.get("summary") or project.get("description") or ""
        description = html.escape(summary[:120] + ("‚Ä¶" if summary and len(summary) > 120 else ""))
        project_href = build_page_url(
            "project_hub",
            {
                "project_id": project_id,
                "project_name": project.get("title"),
            },
        )
        project_launch = ensure_absolute_page_url(project_href)
        rows.append(
            [
                f"{html.escape(project.get('title', '‚Äî'))}<br><small>{description}</small>",
                html.escape(owner_text),
                html.escape(area),
                build_status_badge(status_text, status_variant),
                created,
                signals,
                build_action_button("View Project", project_launch),
            ]
        )
    columns = [
        "üß± Project",
        "üë• Owners",
        "üè¢ Area",
        "üìä Phase",
        "üìÖ Created",
        "‚≠ê Signals",
        "üöÄ Action",
    ]
    render_neon_table("üìÅ Project Hub ‚Äî Live Builds", columns, rows, "Add your first project to the hub.")


def render_help_insights(submissions: list[dict]) -> None:
    total = len(submissions)
    top = sorted(submissions, key=lambda x: x.get("upvotes", 0), reverse=True)[:3]
    highlights = "".join(
        f"<li><strong>{html.escape(item.get('title','‚Äî'))}</strong> ‚Äî üëç {item.get('upvotes',0)} | ‚ö° {item.get('urgency',0):.1f} | üéØ {item.get('impact_score',0):.1f}</li>"
        for item in top
    )
    st.markdown(
        f"""
        <div class="neon-table" style="margin-top:1.5rem;">
            <div class="neon-table-title">üèÜ Kaggle-Style Leaderboard Signals</div>
            <ul style="color:rgba(226,232,240,0.9);line-height:1.7;margin-bottom:1rem;">
                {highlights}
            </ul>
            <p style="color:rgba(148,163,184,0.95);">
                Total challenges: <strong>{total}</strong> ‚Ä¢ Auto-computed ranking blends upvotes, urgency, impact, and discussion velocity.
            </p>
        </div>
        """,
        unsafe_allow_html=True,
    )


def render_help_hub_layer(auth_user: dict | None = None) -> None:
    st.markdown(
        """
        <div class="neon-table" style="margin-bottom:1.5rem;">
            <div class="neon-table-title" style="font-size:1.4rem;">
                üî• How Can AI Help ‚Äî the place where problems find Solutions, painpoints find Cures, People find great people to help them be GREAT 
            </div>
            <p style="color:rgba(226,232,240,0.9);">
                Share real customer or team pain points, let Ambassadors propose AI cures, and convert the best submissions into Customer ONE projects.
            </p>
        </div>
        """,
        unsafe_allow_html=True,
    )
    cta_cols = st.columns([3, 1])
    with cta_cols[0]:
        st.markdown(
            "‚úÖ "
            + (
                f"Logged in as **{auth_user.get('name', auth_user.get('email'))}**. Head into the submission workspace to add your challenge."
                if auth_user
                else "Register or log in to submit your challenge and track solutions."
            )
        )
    with cta_cols[1]:
        if st.button("Submit a Challenge", use_container_width=True):
            go_to_page("pages/how_can_ai_help.py")
    submissions = render_help_submission_table()
    render_help_solution_table()
    render_project_hub_section()
    # Duplicate card layout (Challenge Intake Forms) removed to keep focus on Table 1 feed.
    # render_challenge_form_cards(submissions)
    render_help_insights(submissions)
    st.markdown(
        """
        <div class="neon-table" style="margin-top:1.5rem;">
            <div class="neon-table-title">ü§ñ AI Auto-Blueprint</div>
            <p>Each submission triggers an AI baseline that drafts the A‚ÜíF agent workflow, required datasets, risk notes, suggested UI/API surface, and a timeline estimate.</p>
            <ul>
                <li>üîç Auto-detect similar agents & reusable patterns.</li>
                <li>ü™Ñ Generate ‚ÄúConvert to Project‚Äù payload with owners + version 0.1.</li>
                <li>üë• Tag suggested Ambassadors & SMEs directly from the Human Stack.</li>
            </ul>
        </div>
        """,
        unsafe_allow_html=True,
    )


def render_human_stack_table():
    records = load_meta_records("humans.json", SAMPLE_HUMANS)
    merged: list[dict] = []
    seen: set[str] = set()
    for person in records:
        key = (person.get("id") or person.get("email") or person.get("name") or "").lower()
        if key:
            seen.add(key)
        merged.append(person)
    for sample in SAMPLE_HUMANS:
        key = sample.get("name", "").lower()
        if key and key in seen:
            continue
        merged.append(sample)
        if key:
            seen.add(key)
    records = merged
    rows = []
    for person in records:
        contributions = person.get("contributions") or {}
        project_count = contributions.get("projects", 0)
        agent_count = contributions.get("agents", 0)
        profile_href = build_page_url(
            "human_stack",
            {
                "profile_id": person.get("id"),
                "profile_email": person.get("email"),
            },
        )
        summary = f"üß± {project_count} / ü§ñ {agent_count}"
        ai_contrib = person.get("ai_contributions")
        if ai_contrib:
            summary = f"{summary}<br><small>{html.escape(ai_contrib)}</small>"
        rows.append(
            [
                html.escape(person.get("name", "‚Äî")),
                html.escape(person.get("department", "‚Äî")),
                html.escape(person.get("region", "‚Äî")),
                format_tags(person.get("skills")),
                summary,
                f"{format_date(person.get('created_at'))} / {format_date(person.get('updated_at'))}",
                build_status_badge(person.get("sme_level", "Skilled"), "success"),
                build_action_button("View Profile", profile_href),
            ]
        )
    columns = [
        "üë§ Name",
        "üè¢ Department",
        "üåç Region",
        "üß© Skills / Expertise",
        "üß™ Contributions",
        "üìÖ Joined / Updated",
        "‚≠ê SME Level",
        "üöÄ Action",
    ]
    total_profiles = len(rows)
    table_title = f"üë§ Human Stack Directory ‚Äî {total_profiles} Profiles"
    render_neon_table(table_title, columns, rows, "No Rackers have registered yet.")


AGENT_PAGE_HINTS = {
    "agent_builder": "agent_builder",
    "hf_agent_wrapper": "hf_inspector",
    "agent_manager": "hf_inspector",
    "ceo_driver_dashboard": "ceo_driver_dashboard",
    "chatbot_assistant_agent": "chatbot_assistant",
    "it_troubleshooter_agent": "troubleshooter_agent",
   
}


# Map challenge titles -> page keys for dedicated spec pages
CHALLENGE_SPEC_PAGES: dict[str, str] = {
    "sync rax billing with customer billing format": "challenge_sync_rax_billing",
    "automate monthly billing reconciliation": "challenge_automate_monthly_billing_reconciliation",
    "predict ticket escalations for managed cloud": "challenge_predict_ticket_escalations_for_managed_cloud",
    "openstack deployment readiness validator": "challenge_openstack_deployment_readiness_validator",
    "customer renewal risk insights": "challenge_customer_renewal_risk_insights",
    "onboarding ticket auto-categorizer": "challenge_onboarding_ticket_auto_categorizer",
    "predict capacity exhaustion in infra": "challenge_predict_capacity_exhaustion_in_infra",
    "auto-generate security incident reports": "challenge_auto_generate_security_incident_reports",
    "reduce chat support handle time": "challenge_reduce_chat_support_handle_time",
    "auto-extract partner contract data": "challenge_auto_extract_partner_contract_data",
}


def get_challenge_spec_page(title: str | None) -> str | None:
    """Return the page key for the given challenge title, if known."""
    if not title:
        return None
    key = title.strip().lower()
    return CHALLENGE_SPEC_PAGES.get(key)


def normalize_launch_target(target: str | None) -> str:
    if not target:
        return ""
    value = target.strip()
    if not value:
        return ""
    if value.startswith(("http://", "https://")):
        return value
    if value.startswith("pages/"):
        key = Path(value).stem
        return PAGE_SLUGS.get(key, _slugify_page_stem(key))
    if value.startswith("/"):
        return value
    cleaned = value.strip("/")
    hinted = AGENT_PAGE_HINTS.get(cleaned)
    if hinted and hinted in PAGE_SLUGS:
        return PAGE_SLUGS[hinted]
    if cleaned in PAGE_SLUGS:
        return PAGE_SLUGS[cleaned]
    return f"/{cleaned}"


def generate_agent_page_candidates(route_name: str) -> list[str]:
    candidates: list[str] = []
    for name in (route_name, route_name.strip("_")):
        if name and name not in candidates:
            candidates.append(name)
    suffixes = ("_agent", "_dashboard", "_assistant", "_copilot", "_wizard")
    for suffix in suffixes:
        if route_name.endswith(suffix):
            trimmed = route_name[: -len(suffix)]
            if trimmed and trimmed not in candidates:
                candidates.append(trimmed)
    hinted = AGENT_PAGE_HINTS.get(route_name)
    if hinted and hinted not in candidates:
        candidates.append(hinted)
    return candidates


def resolve_agent_launch_path(route_name: str, overrides: dict[str, str]) -> str:
    for candidate in generate_agent_page_candidates(route_name):
        override = overrides.get(candidate)
        if override:
            return override
        hinted = AGENT_PAGE_HINTS.get(candidate)
        if hinted:
            hinted_override = overrides.get(hinted)
            if hinted_override:
                return hinted_override
            if hinted in PAGE_SLUGS:
                return PAGE_SLUGS[hinted]
        if candidate in PAGE_SLUGS:
            return PAGE_SLUGS[candidate]
    return ""


def render_agent_library_table(current_agents, feedback_data):
    records = load_meta_records("agents.json", [])
    rows = []

    if not records:
        fallback = []
        for agent_tuple in current_agents:
            author = "Rackers Lab"
            created_at = datetime.now().strftime("%Y-%m-%d")
            version = "v1.0.0"
            if len(agent_tuple) >= 10:
                (
                    sector,
                    industry,
                    agent_name,
                    desc,
                    status,
                    emoji,
                    requires_login,
                    author,
                    created_at,
                    version,
                ) = agent_tuple
            elif len(agent_tuple) == 7:
                sector, industry, agent_name, desc, status, emoji, requires_login = agent_tuple
            else:
                sector, industry, agent_name, desc, status, emoji = agent_tuple
                requires_login = False
            fallback.append(
                {
                    "industry": industry or sector,
                    "name": agent_name,
                    "author": author,
                    "created_at": created_at,
                    "version": version,
                    "description": desc,
                    "status": status,
                    "requires_login": requires_login,
                }
            )
        records = fallback

    base_launch_targets = {
        "agent_builder": "agent_builder",
        "hf_agent_wrapper": "hf_inspector",
        "hf_wrapper": "hf_inspector",
        "agent_manager": "hf_inspector",
        "chatbot_assistant": "chatbot_assistant",
        "real_estate_evaluator_agent": "real_estate_evaluator",
        "real_estate_evaluator": "real_estate_evaluator",
        "real_estate_evaluator_copy": "real_estate_evaluator_copy",
        "ceo_driver_dashboard": "ceo_driver_dashboard",
 
    }
    launch_overrides: dict[str, str] = {}
    for key, raw_target in base_launch_targets.items():
        normalized = normalize_launch_target(raw_target)
        if normalized:
            launch_overrides[key] = normalized
    for key, raw_target in CUSTOM_AGENT_LAUNCHES.items():
        normalized = normalize_launch_target(raw_target)
        if normalized:
            launch_overrides[key] = normalized

    for agent in records:
        name = agent.get("name") or agent.get("agent")
        industry = agent.get("industry") or agent.get("sector", "Cross-Industry")
        description = agent.get("description", "")
        route_name = compute_route_name(name or "agent")
        fb = feedback_data.get(name, {"rating": 0, "users": 0, "comments": []})
        rating_html = render_star_rating(fb.get("rating"))
        comments = len(fb.get("comments", []))
        launch_path = resolve_agent_launch_path(route_name, launch_overrides)
        if launch_path:
            if launch_path.startswith(("http://", "https://")):
                href = launch_path
            elif launch_path.startswith("/"):
                href = launch_path
            else:
                href = f"{LAUNCH_BASE_URL}{launch_path}"
            action = build_action_stack("Launch", href, "Edit / View")
        else:
            action = "<div class='action-stack'><span class='status-badge warning'>Coming Soon</span></div>"
        challenge_text = agent.get("challenge") or description
        rows.append(
            [
                html.escape(industry),
                html.escape(name or "‚Äî"),
                html.escape(agent.get("author", "dzoan.nguyen@rackspace")),
                format_date(agent.get("created_at")),
                html.escape(agent.get("version", "v1.0.0")),
                html.escape(challenge_text),
                f"üë• {fb.get('users', 0)}",
                f"üí¨ {comments}",
                rating_html,
                action,
            ]
        )

    columns = [
        "üè≠ Industry",
        "ü§ñ Agent Name",
        "üë§ Author",
        "üìÖ Created On",
        "üîÅ Version",
        "üìÑ Challenge",
        "üë• Users",
        "üí¨ Comments",
        "‚≠ê Rating",
        "üöÄ Action",
    ]
    render_neon_table("ü§ñ Global AI Agent Library", columns, rows, "Agents will appear once published to the library.")


def render_ontology_table():
    records = load_meta_records("patterns.json", SAMPLE_PATTERNS)
    rows = []
    for pattern in records:
        pattern_slug = compute_route_name(pattern.get("name", "pattern"))
        pattern_href = build_page_url(
            "ontology_patterns",
            {
                "pattern": pattern_slug,
            },
        )
        rows.append(
            [
                html.escape(pattern.get("name", "‚Äî")),
                html.escape(pattern.get("description", "‚Äî")),
                html.escape(pattern.get("domain", "‚Äî")),
                format_tags(pattern.get("use_cases")),
                html.escape(pattern.get("author", "Rackers Lab")),
                format_date(pattern.get("created_at")),
                build_action_button("Open Pattern", pattern_href),
            ]
        )
    columns = [
        "üß† Pattern Name",
        "üìÑ Description",
        "üè¢ Domain",
        "üß™ Use Cases",
        "üë§ Author",
        "üìÖ Created On",
        "üöÄ Action",
    ]
    render_neon_table("üß† Ontology & Pattern Library", columns, rows, "Add the first ontology asset to unlock this grid.")


def render_docs_table():
    records = load_meta_records("docs.json", SAMPLE_DOCS)
    rows = []
    for doc in records:
        doc_slug = compute_route_name(doc.get("title", "doc"))
        doc_href = build_page_url(
            "documentation_learning",
            {
                "doc": doc_slug,
            },
        )
        rows.append(
            [
                html.escape(doc.get("title", "‚Äî")),
                html.escape(doc.get("category", "Guide")),
                html.escape(doc.get("author", "Rackers Lab")),
                format_date(doc.get("updated_at")),
                html.escape(doc.get("read_time", "‚Äî")),
                render_star_rating(doc.get("rating")),
                build_action_button("Read", doc_href),
            ]
        )
    columns = [
        "üìò Document Title",
        "üìÅ Category",
        "üë§ Author",
        "üìÖ Last Updated",
        "‚è±Ô∏è Reading Time",
        "‚≠ê Rating",
        "üöÄ Action",
    ]
    render_neon_table("üìö Documentation & Learning", columns, rows, "Docs will appear once published to the YES AI CAN shelf.")


def render_community_table():
    records = load_meta_records("community.json", SAMPLE_COMMUNITY)
    rows = []
    for member in records:
        member_slug = compute_route_name(member.get("name", "member"))
        member_href = build_page_url(
            "community_ambassadors",
            {
                "member": member_slug,
            },
        )
        rows.append(
            [
                html.escape(member.get("name", "‚Äî")),
                html.escape(member.get("department", "‚Äî")),
                html.escape(member.get("region", "‚Äî")),
                format_tags(member.get("skills")),
                format_tags(member.get("badges")),
                format_tags(member.get("contributions")),
                html.escape(member.get("cohort", "‚Äî")),
                build_action_button("View Profile", member_href),
            ]
        )
    columns = [
        "üëë Ambassador / Contributor",
        "üè¢ Department",
        "üåç Region",
        "üß© Skillset Focus",
        "üéñÔ∏è Badges / Achievements",
        "üì¶ Contributions",
        "üìÖ Cohort / Year",
        "üöÄ Action",
    ]
    render_neon_table("üåç Community & Ambassadors", columns, rows, "Ambassador cohorts will populate here.")


def render_admin_tools_table():
    records = load_meta_records("admin_tools.json", SAMPLE_ADMIN)
    rows = []
    for tool in records:
        telemetry = (tool.get("telemetry") or "").lower()
        variant = "success" if telemetry == "stable" else "warning"
        tool_slug = compute_route_name(tool.get("name", "tool"))
        tool_href = build_page_url(
            "admin_rex",
            {
                "tool": tool_slug,
            },
        )
        rows.append(
            [
                html.escape(tool.get("name", "‚Äî")),
                html.escape(tool.get("description", "‚Äî")),
                html.escape(tool.get("category", "Ops")),
                build_status_badge(tool.get("telemetry", "Beta"), variant),
                format_date(tool.get("updated_at")),
                build_action_button("Open", tool_href),
            ]
        )
    columns = [
        "‚öôÔ∏è Tool / Feature",
        "üìÑ Description",
        "üîß Category",
        "üìä Telemetry Status",
        "üìÖ Last Updated",
        "üöÄ Action",
    ]
    render_neon_table("‚öôÔ∏è Admin Tools / REX 2.0", columns, rows, "Admin stacks will surface here once configured.")


def render_global_search_table():
    records = load_meta_records("search_index.json", SAMPLE_SEARCH)
    rows = []
    for result in records:
        search_href = build_page_url(
            "search",
            {
                "query": result.get("title"),
                "type": result.get("type"),
            },
        )
        rows.append(
            [
                html.escape(result.get("type", "‚Äî")),
                html.escape(result.get("title", "‚Äî")),
                html.escape(result.get("category", "‚Äî")),
                html.escape(result.get("owner", "‚Äî")),
                format_date(result.get("updated_at")),
                build_action_button("Open", search_href),
            ]
        )
    columns = [
        "üîç Result Type",
        "üè∑Ô∏è Name / Title",
        "üìÇ Category",
        "üë§ Owner",
        "üìÖ Last Updated",
        "üöÄ Action",
    ]
    render_neon_table("üîç Unified Search Index", columns, rows, "Search index will refresh once metadata is ingested.")


def render_hero_section(auth_user: dict | None) -> None:
    st.markdown("<div class='left-box'>", unsafe_allow_html=True)
    st.markdown(
        """
        <div class="hero-title">üéâ YES AI CAN ‚Äî Rackers Lab & Community</div>
        <div class="hero-subtitle">Where Rackers build, learn, and innovate with AI ‚Äî together.</div>
        """,
        unsafe_allow_html=True,
    )
    st.markdown(
        """
        <div class="feature-card">
            <div class="feature-title">YES AI CAN is built to:</div>
            <ul class="feature-list">
                <li>Map global AI & domain expertise.</li>
                <li>Showcase prototypes, MVPs, and production launches.</li>
                <li>Provide neon-fast zero-code tooling for explainable agents.</li>
                <li>Accelerate reuse from Customer ZERO to Customer ONE.</li>
                <li>Connect Ambassadors, SMEs, and dreamers across regions.</li>
            </ul>
        </div>
        """,
        unsafe_allow_html=True,
    )
    st.markdown(
        """
        <div class="feature-card">
            <div class="feature-title">üß© Challenge & Solution Flow</div>
            <p><strong>As User / Live Improver</strong></p>
            <ul class="feature-list">
                <li>Submit any pain point or workflow (‚ÄúHow Can AI Help?‚Äù)</li>
                <li>Report improvement needs or new ideas to the community</li>
            </ul>
            <p><strong>As Solution Finder / Builder</strong></p>
            <ul class="feature-list">
                <li>Help Rackers solve real-life problems</li>
                <li>Build AI tools that improve tasks, workflows, and happiness</li>
            </ul>
            <p><strong>Next action</strong></p>
            <p>Create your Human Stack Profile (skills, experience, resume, expertise)</p>
        </div>
        """,
        unsafe_allow_html=True,
    )
    st.markdown(
        """
        <div class="feature-card feature-card-blue">
            <div class="feature-title feature-title-blue">üí° Why Now?</div>
            <p class="feature-text feature-text-white">
                Rackspace has <strong style="color:#00d4ff;">5,000+ hidden superpowers.</strong>
                YES AI CAN discovers them and gives every Racker the platform to say ‚ÄúYES, AI CAN.‚Äù
            </p>
        </div>
        """,
        unsafe_allow_html=True,
    )
    st.markdown(
        """
        <div class="feature-card">
            <div class="feature-title">üß± What You Can Do Here</div>
            <h4>üí¨ As a User ‚Äî Live Improver</h4>
            <p><strong>Submit a Pain Point or Workflow ‚Äî ‚ÄúHow Can AI Help?‚Äù</strong><br>
            Share any challenge, repetitive task, manual workflow, or inefficiency in your daily work.<br>
            Your submission becomes a real challenge for the community to solve ‚Äî together.</p>
            <p><strong>Report Any Pain Point, Improvement Need, or Idea</strong><br>
            Tell the community what slows you down, what‚Äôs broken, or what could be better.<br>
            Every idea becomes fuel for the next internal AI tool, automation, or workflow upgrade.</p>
            <h4>üõ†Ô∏è As a Solution Finder or Builder ‚Äî Solve Real Rackers‚Äô Problems</h4>
            <p>Step in to help your teammates by designing or proposing AI-powered solutions.<br>
            Use zero-code tools or your technical skills to:</p>
            <ul class="feature-list">
                <li>Automate repetitive tasks</li>
                <li>Streamline complex workflows</li>
                <li>Improve accuracy and efficiency</li>
                <li>Reduce frustration</li>
                <li>Make someone‚Äôs day easier ‚Äî and happier</li>
            </ul>
            <p>Every problem submitted is an opportunity for you to build something impactful.</p>
            <h4>üëâ Next Action: Create Your Human Stack Profile</h4>
            <p><strong>üë§ Create your Human Stack Profile</strong> ‚Äî Showcase your skills, domain expertise, role & department, resume, AI experience, and the projects you‚Äôve built or contributed to.<br>
            Your profile helps others find you, collaborate with you, and invite you to solve challenges that match your strengths.</p>
        </div>
        """,
        unsafe_allow_html=True,
    )
    if auth_user:
        st.success(f"Welcome back, **{auth_user.get('name', auth_user.get('email'))}** ‚Äî open *Login / My Space* to keep building.")
    else:
        st.info("üîê Already registered? Visit **Login / My Space** to access your personal workspace and neon dashboards.")
    st.markdown("</div>", unsafe_allow_html=True)


def render_navigation_center(current_agents, feedback_data, auth_user) -> None:
    wrapper_class = "nav-center-wrapper"
    if st.session_state.get("yes_theme", "dark") != "dark":
        wrapper_class += " light"
    st.markdown(f"<div class='{wrapper_class}'>", unsafe_allow_html=True)
    st.markdown("<div class='nav-command-grid'>", unsafe_allow_html=True)
    sections = [
        {
            "icon": "üë§",
            "label": "Builder Team Directory",
            "description": "Discover multi-skill Rackers powering every build.",
            "page": "pages/human_stack.py",
            "renderer": render_human_stack_table,
        },
        {
            "icon": "ü§ñ",
            "label": "Agent Library",
            "description": "Launch Customer ZERO agents or publish to Customer ONE.",
            "page": "pages/agent_library.py",
            "renderer": lambda: render_agent_library_table(current_agents, feedback_data),
        },
        {
            "icon": "üß†",
            "label": "Ontology & Patterns",
            "description": "Reusable logic, prompts, and governance templates.",
            "page": "pages/ontology_patterns.py",
            "renderer": render_ontology_table,
        },
        {
            "icon": "üìö",
            "label": "Docs & Learning",
            "description": "Playbooks, guides, and Ambassador learning paths.",
            "page": "pages/documentation_learning.py",
            "renderer": render_docs_table,
        },
        {
            "icon": "üåç",
            "label": "Community & Ambassadors",
            "description": "Cohorts, events, leaderboards, and badges.",
            "page": "pages/community_ambassadors.py",
            "renderer": render_community_table,
        },
        {
            "icon": "‚öôÔ∏è",
            "label": "Admin & REX 2.0",
            "description": "Ops telemetry, exports, and integration feeds.",
            "page": "pages/admin_rex.py",
            "renderer": render_admin_tools_table,
        },
        {
            "icon": "üîç",
            "label": "Global Search",
            "description": "Fuzzy search across profiles, projects, agents, and tags.",
            "page": "pages/search.py",
            "renderer": render_global_search_table,
        },
    ]
    for section in sections:
        st.markdown("<div class='nav-mini-block'>", unsafe_allow_html=True)
        key = f"nav_center_{section['label'].lower().replace(' ', '_')}"
        target_page = section.get("page")
        if st.button(f"{section['icon']} {section['label']}", key=key, use_container_width=True):
            if target_page:
                go_to_page(target_page)
        st.markdown(f"<div class='nav-mini-desc'>{section['description']}</div>", unsafe_allow_html=True)
        renderer: Callable[[], None] | None = section.get("renderer")
        if renderer:
            renderer()
        st.markdown("</div>", unsafe_allow_html=True)
    st.markdown("</div>", unsafe_allow_html=True)
    st.markdown("</div>", unsafe_allow_html=True)


def render_future_modules():
    st.markdown("<div class='nav-bottom-grid'>", unsafe_allow_html=True)
    cards = [
        ("üî• Trending Agents", "Track which neon builds are earning the most traction across customers.", "View leaderboard"),
        ("üÜï Latest Projects", "Fresh prototypes, MVPs, and production launches from Rackers worldwide.", "Open project feed"),
        ("üåü New Rackers", "Welcome the builders, designers, and SMEs joining the lab this week.", "Meet the cohort"),
        ("üí° Popular Searches", "See the topics, industries, and use cases everyone is exploring.", "Explore insights"),
    ]
    for title, body, cta in cards:
        st.markdown(
            f"""
            <div class="nav-bottom-card">
                <h4>{title}</h4>
                <p>{body}</p>
            </div>
            """,
            unsafe_allow_html=True,
        )
    st.markdown("</div>", unsafe_allow_html=True)
# ============================================================
# MAIN LAYOUT: LEFT PANEL (Hero) + RIGHT PANEL (Navigation)
# ============================================================

# Two-column layout
c1, c2 = st.columns([1.1, 1.9], gap="large")

# LEFT PANEL ‚Äî Hero Message
with c1:
    st.markdown("<div class='left-box'>", unsafe_allow_html=True)
    
    st.markdown("""
        <div class="hero-title">üéâ YES AI CAN</div>
        <div class="hero-subtitle">Rackers Lab & Community ‚Äî Where Problems Find Solutions, Pain Points Find Cure, Great People Find Great People to Build Everyday a better Rackspace and a Better World.</div>
        <p class="hero-body-text">
            This is Rackspace‚Äôs internal, human-centered AI innovation ecosystem ‚Äî a place where Rackers submit real problems, discover teammates, build solutions, and turn ideas into production-ready AI. Here, everyone can participate: technical or not. Every challenge becomes an opportunity. Every Racker becomes a creator.
        </p>
    """, unsafe_allow_html=True)
    
    st.markdown("""
        <div class="feature-card">
            <div class="feature-title">üåå What YES AI CAN Is</div>
            <p class="feature-text">
                YES AI CAN is Rackspace‚Äôs AI Foundry + Community Agent Factory, built to:
            </p>
            <ul class="feature-list">
                <li>üß† Mine our global superpowers ‚Äî map every skill, SME, and domain expert</li>
                <li>üîç Collect real business pain points ‚Äî Kaggle-style challenge submissions</li>
                <li>üöÄ Turn problems into agents ‚Äî Customer ZERO ‚Üí Customer ONE blueprints</li>
                <li>ü™Ñ Give zero-code tools for creating explainable AI agents instantly</li>
                <li>ü§ù Connect Ambassadors, SMEs, engineers, and innovators</li>
                <li>‚ôªÔ∏è Accelerate reuse through a shared, governed agent library</li>
                <li>üèóÔ∏è Power the next generation of OpenStack + private AI solutions</li>
                <li>üåè Unite Rackers globally into one open innovation community</li>
            </ul>
        </div>
    """, unsafe_allow_html=True)
    
    st.markdown("""
        <div class="feature-card feature-card-blue">
            <div class="feature-title feature-title-blue">üí° Why We Exist</div>
            <p class="feature-text feature-text-white">
                Rackspace has 5,000+ hidden superpowers ‚Äî unique skills, ideas, and lived experiences waiting to be unlocked. YES AI CAN is the place where those superpowers become visible: in profiles, in projects, in prototypes, in agents, in solutions, and in community.
            </p>
            <p class="feature-text feature-text-white" style="margin-top: 1rem;">
                Our mission: Give every Racker ‚Äî regardless of background ‚Äî the confidence, tools, and platform to say: <strong style="color: #00d4ff;">‚ÄúYES, AI CAN ‚Äî and so can I.‚Äù</strong>
            </p>
        </div>
    """, unsafe_allow_html=True)
    
    st.markdown("""
        <div class="feature-card">
            <div class="feature-title">üß© Challenge & Solution Flow</div>
            <p><strong>As User / Live Improver</strong></p>
            <ul class="feature-list">
                <li>Submit any pain point or workflow (‚ÄúHow Can AI Help?‚Äù)</li>
                <li>Report improvement needs or new ideas to the community</li>
            </ul>
            <p><strong>As Solution Finder / Builder</strong></p>
            <ul class="feature-list">
                <li>Help Rackers solve real-life problems</li>
                <li>Build AI tools that improve tasks, workflows, and happiness</li>
            </ul>
            <p><strong>Next action</strong></p>
            <p>Create your Human Stack Profile (skills, experience, resume, expertise)</p>
        </div>
    """, unsafe_allow_html=True)
    
    st.markdown("""
        <div class="feature-card">
            <div class="feature-title">üß± What You Can Do Here</div>
            <h4>üí¨ As a User ‚Äî Live Improver</h4>
            <p><strong>Submit a Pain Point or Workflow ‚Äî ‚ÄúHow Can AI Help?‚Äù</strong><br>
            Share any challenge, repetitive task, manual workflow, or inefficiency in your daily work.<br>
            Your submission becomes a real challenge for the community to solve ‚Äî together.</p>
            <p><strong>Report Any Pain Point, Improvement Need, or Idea</strong><br>
            Tell the community what slows you down, what‚Äôs broken, or what could be better.<br>
            Every idea becomes fuel for the next internal AI tool, automation, or workflow upgrade.</p>
            <h4>üõ†Ô∏è As a Solution Finder or Builder ‚Äî Solve Real Rackers‚Äô Problems</h4>
            <p>Step in to help your teammates by designing or proposing AI-powered solutions.<br>
            Use zero-code tools or your technical skills to:</p>
            <ul class="feature-list">
                <li>Automate repetitive tasks</li>
                <li>Streamline complex workflows</li>
                <li>Improve accuracy and efficiency</li>
                <li>Reduce frustration</li>
                <li>Make someone‚Äôs day easier ‚Äî and happier</li>
            </ul>
            <p>Every problem submitted is an opportunity for you to build something impactful.</p>
            <h4>üëâ Next Action: Create Your Human Stack Profile</h4>
            <p><strong>üë§ Create your Human Stack Profile</strong> ‚Äî Showcase your skills, domain expertise, role & department, resume, AI experience, and the projects you‚Äôve built or contributed to.<br>
            Your profile helps others find you, collaborate with you, and invite you to solve challenges that match your strengths.</p>
        </div>
    """, unsafe_allow_html=True)
    
    st.markdown("""
        <div class="feature-card feature-card-blue">
            <div class="feature-title feature-title-blue">üöÄ Built for You</div>
            <p class="feature-text feature-text-white">
                Whether you're an engineer, analyst, salesperson, manager, operator, or creator ‚Äî YES AI CAN is your footstool into AI, designed for zero fear, zero barriers, zero cost, maximum clarity, maximum support, maximum impact.
            </p>
            <p class="feature-text feature-text-white" style="margin-top: 1rem;">
                This is how Rackspace builds a future where AI is safe, transparent, explainable, human-centered, and globally collaborative.
            </p>
            <p class="feature-text feature-text-white" style="margin-top: 1rem; text-align: center; font-size: 18px; font-weight: 600; color: #00d4ff;">
                ü´Ç Welcome to the Future of Human-Centered AI at Rackspace<br>
                Here, ideas turn into prototypes. Prototypes turn into agents. Agents turn into products. And Rackers turn into creators.
            </p>
        </div>
    """, unsafe_allow_html=True)
    render_quick_access(auth_user, origin="hero")
    render_primary_navigation_buttons()
    # Duplicate call with similar content exists elsewhere; keeping left panel lighter by
    # skipping the extra ‚ÄúJump into Forms & Workspaces‚Äù block for now.
    # render_form_navigation_buttons()
    
    if auth_user:
        st.success("‚úÖ You're logged in ‚Äî jump into **Login / My Space** to manage your projects.")
    else:
        st.info("üîê Already registered? Head to **Login / My Space** to access your personal dashboard.")
        if st.button("Go to Login / My Space", key="hero_login_button", use_container_width=True):
            go_to_page("pages/login_portal.py")
    
    st.markdown("</div>", unsafe_allow_html=True)

# RIGHT PANEL ‚Äî Navigation and Home Page Layers
with c2:
    st.markdown("<div class='right-box'>", unsafe_allow_html=True)
    st.markdown(
        """
        <div class="nav-center-header" style="margin-bottom:1rem;">
            <h2>üè† YES AI CAN </h2>
            <p> the Place where Great peole help People become Greater </p>
        </div>
        """,
        unsafe_allow_html=True,
    )
    render_help_hub_layer(auth_user)
    #render_quick_access(auth_user, origin="right")

    status_col, toggle_col = st.columns([3, 1])
    with status_col:
        if auth_user:
            st.markdown(f"‚úÖ Logged in as **{auth_user.get('name', auth_user.get('email'))}**")
        else:
            st.markdown("üîê Not logged in ‚Äî visit *Login / My Space* to personalize")
    with toggle_col:
        is_dark = st.session_state.get("yes_theme") == "dark"
        theme_toggle = st.toggle("üåó Dark Mode", value=is_dark, key="theme_toggle")
        new_theme = "dark" if theme_toggle else "light"
        if new_theme != st.session_state["yes_theme"]:
            st.session_state["yes_theme"] = new_theme
            st.experimental_rerun()

    render_navigation_center(AGENTS, feedback_data, auth_user)
    render_future_modules()

    st.markdown("</div>", unsafe_allow_html=True)

st.markdown("---")

# Footer
st.markdown("""
    <footer>
        üíé YES AI CAN ‚Äî Rackers Lab & Community |  Made with ‚ù§Ô∏è by Dzoan.nguyen@Rackspace.com
    </footer>
""", unsafe_allow_html=True)
