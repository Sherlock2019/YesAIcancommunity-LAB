# services/ui/app.py
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸŒ OpenSource AI Agent Library + Credit Appraisal PoC by Dzoan
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
from __future__ import annotations
import os
import re
import io
import json
from datetime import datetime, timezone
from typing import Optional, Dict, List, Any
import pandas as pd
import numpy as np
import streamlit as st
import requests
import plotly.express as px
import plotly.graph_objects as go
import logging
import sys

from pandas import json_normalize  # ADD



# Theme bootstrapping
if "ui_theme" not in st.session_state:
    st.session_state["ui_theme"] = "dark"   # default bright



#THEME SWITCHER

def apply_theme(theme: str = "light"):
    # Keep palette compact so it's easy to tune
    if theme == "light":
        bg      = "#ffffff"
        text    = "#0f172a"
        subtext = "#334155"
        card    = "#f8fafc"
        border  = "#e2e8f0"
        accent  = "#2563eb"
        accent2 = "#22c55e"
        tab_bg  = "#eef2ff"
        table_bg= "#ffffff"
        table_head_bg = "#e2e8f0"
        table_head_tx = "#0f172a"
    else:  # dark
        bg      = "#0E1117"
        text    = "#f1f5f9"
        subtext = "#93a4b8"
        card    = "#0f172a"
        border  = "#334155"
        accent  = "#3b82f6"
        accent2 = "#22c55e"
        tab_bg  = "#111418"
        table_bg= "#0f172a"
        table_head_bg = "#1e293b"
        table_head_tx = "#93c5fd"

    st.markdown(f"""
    <style>
      /* App bg + text */
      .stApp {{
        background: {bg} !important;
        color: {text} !important;
      }}
      .stCaption, .stMarkdown p, .stMarkdown li, .st-emotion-cache-16idsys {{
        color: {subtext} !important;
      }}

      /* Buttons */
      .stButton>button {{
        background-color: {accent} !important;
        color: white !important;
        border-radius: 8px !important;
        font-weight: 600 !important;
        border: 1px solid {border} !important;
      }}
      .stButton>button:hover {{
        filter: brightness(0.95);
      }}

      /* Tabs */
      .stTabs [data-baseweb="tab-list"] button {{
        color: {text} !important;
        background: {tab_bg} !important;
        border-radius: 10px !important;
        margin-right: 4px !important;
        border: 1px solid {border} !important;
      }}
      .stTabs [data-baseweb="tab-list"] button[aria-selected="true"] {{
        background-color: {accent} !important;
        color: #ffffff !important;
      }}

      /* Dataframe/Data Editor container */
      [data-testid="stDataFrame"] {{
        background-color: {table_bg} !important;
        color: {text} !important;
        border-radius: 10px !important;
        border: 1px solid {border} !important;
        box-shadow: 0 4px 18px rgba(0,0,0,0.2) !important;
      }}
      [data-testid="stDataFrame"] thead tr th {{
        background: {table_head_bg} !important;
        color: {table_head_tx} !important;
        font-weight: 700 !important;
        border-bottom: 2px solid {accent} !important;
      }}
      [data-testid="stDataFrameCell"]:not([data-testid="stDataFrameCellEditable"]) {{
        background-color: {table_bg} !important;
        color: {text} !important;
        border-color: {border} !important;
      }}
      [data-testid="stDataFrameCellEditable"] textarea {{
        background-color: {card} !important;
        color: {text} !important;
        border: 1px solid {border} !important;
        border-radius: 6px !important;
      }}
      [data-testid="stDataFrameCellEditable"]:focus-within textarea,
      [data-testid="stDataFrameCellEditable"]:hover textarea {{
        border-color: {accent2} !important;
        box-shadow: 0 0 0 2px rgba(34,197,94,0.35) !important;
      }}

      /* Horizontal rules */
      hr, .stMarkdown hr {{
        border-color: {border} !important;
      }}
    </style>
    """, unsafe_allow_html=True)



# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CREDIT AGENT â€” HEADER (used in credit flow)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import streamlit as st  # (no-op if already imported)

def render_credit_header():
    ss = st.session_state

    # pick a display name if available
    user = (
        (ss.get("credit_user") or {}).get("name")
        or (ss.get("asset_user") or {}).get("name")
        or (ss.get("user_info") or {}).get("name")
        or "guest"
    )

    # use your theme switch (defaults to dark)
    theme = ss.get("theme", "dark")
    brand = {
        "dark": {"text":"#e2e8f0","muted":"#94a3b8","accent":"#3b82f6"},
        "light":{"text":"#0f172a","muted":"#475569","accent":"#2563eb"},
    }[theme]

    st.title("ğŸ¦ Credit Appraisal Agent")
    st.caption(
        "Aâ†’H pipeline â€” Intake â†’ Privacy â†’ Credit Appraisal â†’ Human Review â†’ "
        "Training â†’ Deployment â†’ Monitoring â†’ Reporting "
        f"| ğŸ‘‹ {user}"
    )

# âœ… JSON â†’ DataFrame converter (final, unified, safe)
# ============================================================
def json_to_dataframe(payload) -> pd.DataFrame:
    """
    Convert arbitrary API JSON (dict/list/bytes/str) into a DataFrame.
    Prefers server 'artifacts.merged_csv' â†’ fallback to json_normalize.
    """

    # -------------------------------
    # Case 1: payload is dict
    # -------------------------------
    if isinstance(payload, dict):

        # âœ… Try artifacts.merged_csv first
        res = payload.get("result") or payload
        artifacts = res.get("artifacts") or {}
        merged_csv = artifacts.get("merged_csv")

        if isinstance(merged_csv, str) and os.path.exists(merged_csv):
            try:
                return pd.read_csv(merged_csv)
            except Exception:
                pass

        # âœ… Embedded merged_df inside the JSON
        if "merged_df" in res:
            try:
                return pd.DataFrame(res["merged_df"])
            except Exception:
                pass

        # âœ… If result is list â†’ DF
        if isinstance(res, list):
            try:
                return pd.DataFrame(res)
            except Exception:
                try:
                    return pd.json_normalize(res)
                except Exception:
                    pass

        # âœ… Try keys inside result
        for key in ("rows", "data", "result", "results", "items", "records"):
            if key in res:
                try:
                    return json_to_dataframe(res[key])
                except Exception:
                    pass

    # -------------------------------
    # Case 2: payload is list
    # -------------------------------
    if isinstance(payload, list):
        if len(payload) == 0:
            return pd.DataFrame()
        if all(isinstance(x, dict) for x in payload):
            try:
                return pd.DataFrame(payload)
            except:
                return pd.json_normalize(payload)
        return pd.DataFrame({"value": payload})

    # -------------------------------
    # Case 3: payload is bytes
    # -------------------------------
    if isinstance(payload, bytes):
        try:
            payload = payload.decode("utf-8", errors="ignore")
        except:
            return pd.DataFrame({"value": [repr(payload)]})

    # -------------------------------
    # Case 4: payload is str â†’ try JSON parse
    # -------------------------------
    if isinstance(payload, str):
        payload = payload.strip()
        if not payload:
            return pd.DataFrame()
        try:
            j = json.loads(payload)
            return json_to_dataframe(j)
        except:
            # Fallback â†’ line-by-line DF
            lines = [ln for ln in payload.splitlines() if ln.strip()]
            return pd.DataFrame({"value": lines}) if lines else pd.DataFrame()

    # -------------------------------
    # Default fallback
    # -------------------------------
    return pd.DataFrame({"value": [payload]})



def _extract_run_fields(raw_json):  # ADD
    """
    Return (run_id, normalized_payload_dict).
    Ensures downstream code always receives a dict-like 'payload'.
    """
    run_id = extract_run_id(raw_json)

    # Normalize to dict payload so later code can access keys safely
    payload = raw_json
    if not isinstance(payload, dict):
        if isinstance(payload, list):
            first_dict = next((x for x in payload if isinstance(x, dict)), None)
            payload = first_dict if first_dict is not None else {"result": raw_json}
        else:
            payload = {"result": raw_json}
    return run_id, payload





# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# GLOBAL PAGE CONFIG + HIDE SIDEBAR
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="AI Sandbox â€” By the People, For the People",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# ğŸ’¡ Hide multipage sidebar completely
st.markdown("""
    <style>
    [data-testid="stSidebar"],
    section[data-testid="stSidebar"],
    div[data-testid="stSidebarNav"],
    nav[data-testid="stSidebarNav"] {
        display: none !important;
        visibility: hidden !important;
    }
    [data-testid="stAppViewContainer"] {
        margin-left: 0 !important;
        padding-left: 0 !important;
    }
    </style>
""", unsafe_allow_html=True)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# GLOBAL CONFIG (directories + API)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BASE_DIR = os.path.expanduser("~/AI-AIGENTbythePeoplesANDBOX/HUGKAG/services/ui")
LANDING_IMG_DIR = os.path.join(BASE_DIR, "landing_images")
RUNS_DIR = os.path.join(BASE_DIR, ".runs")
TMP_FEEDBACK_DIR = os.path.join(BASE_DIR, ".tmp_feedback")

for d in (LANDING_IMG_DIR, RUNS_DIR, TMP_FEEDBACK_DIR):
    os.makedirs(d, exist_ok=True)

API_URL = os.getenv("API_URL", "http://localhost:8090")



# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# UNIVERSAL TOP NAVIGATION
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def render_nav_bar_app():
    stage = st.session_state.get("stage", "landing")

    # visibility logic
    show_home   = stage in ("agents", "credit_agent", "asset_agent")
    show_agents = stage not in ("landing", "agents")

    # nothing on landing
    if not (show_home or show_agents):
        return

    c1, c2, _ = st.columns([1, 1, 6])

    with c1:
        if show_home and st.button("ğŸ  Back to Home", key=f"btn_home_{stage}"):
            st.session_state.stage = "landing"
            st.rerun()  # already in app.py â†’ rerun only

    with c2:
        if show_agents and st.button("ğŸ¤– Back to Agents", key=f"btn_agents_{stage}"):
            st.session_state.stage = "agents"
            st.rerun()  # already in app.py â†’ rerun only

    st.markdown("---")



# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # UNIVERSAL TOP NAVIGATION + THEME TOGGLE (fixed)
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# def render_nav_bar_app():
#     import streamlit as st
#     ss = st.session_state  # âœ… define session alias

#     # --- stage & visibility
#     stage = ss.get("stage", "landing")
#     show_home   = stage in ("agents", "credit_agent", "asset_agent")
#     show_agents = stage not in ("landing", "agents")

#     # nothing to render on pure landing
#     if not (show_home or show_agents):
#         return

#     # --- theme state: migrate old key and set default
#     # Theme state
#     ss.setdefault("theme", "dark")

    
#     # if "theme" not in ss and "ui_theme" in ss:
#     #     ss["theme"] = ss["ui_theme"]
#     # ss.setdefault("theme", "dark")
#     # ss["ui_theme"] = ss.get("theme", "dark")  # keep both in sync

#     # three columns: home, agents, theme toggle
#     c1, c2, c3 = st.columns([1, 1, 2.5])

#     with c1:
#         if show_home and st.button("ğŸ  Back to Home", key=f"btn_home_{stage}"):
#             _go_stage("landing")
#             st.stop()

#     with c2:
#         if show_agents and st.button("ğŸ¤– Back to Agents", key=f"btn_agents_{stage}"):
#             _go_stage("agents")
#             st.stop()

#     with c3:
#         is_dark = (ss.get("theme", "dark") == "dark")
#         new_is_dark = st.toggle(
#             "ğŸŒ™ Dark mode",
#             value=is_dark,
#             key="ui_theme_toggle",
#             help="Switch theme"
#         )
#         new_theme = "dark" if new_is_dark else "light"
#         if new_theme != ss.get("theme"):
#             ss["theme"] = new_theme      # âœ… primary key
#             ss["ui_theme"] = new_theme   # âœ… legacy key stays in sync
#             apply_theme(ss["theme"])     # your existing helper

#     st.markdown("---")






# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SESSION STATE INIT
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "stage" not in st.session_state:
    st.session_state.stage = "landing"
if "user_info" not in st.session_state:
    st.session_state.user_info = {"name": "", "email": "", "flagged": False}
if "logged_in" not in st.session_state:
    st.session_state.logged_in = False
if "flagged" not in st.session_state.user_info:
    st.session_state.user_info["flagged"] = False
if "timestamp" not in st.session_state.user_info:
    st.session_state.user_info["timestamp"] = datetime.now(timezone.utc).isoformat()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# RENDER UNIVERSAL NAV BAR
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
render_nav_bar_app()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# HELPERS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _extract_run_fields(res_json):
    """
    Return (run_id, result_dict) from API responses that may be dicts or lists.
    """
    run_id = None
    result_obj = {}

    if isinstance(res_json, dict):
        run_id = (
            res_json.get("run_id")
            or res_json.get("id")
            or (res_json.get("data") or {}).get("run_id")
        )
        result_obj = (
            res_json.get("result")
            or (res_json.get("data") or {}).get("result")
            or {}
        )

    elif isinstance(res_json, list):
        # Find first dict item that contains identifiers/results
        for item in res_json:
            if isinstance(item, dict):
                if not run_id:
                    run_id = item.get("run_id") or item.get("id")
                if not result_obj:
                    result_obj = item.get("result") or {}
                if run_id and result_obj != {}:
                    break
        # If still nothing and list[0] is a dict, use it as best-effort
        if not run_id and res_json and isinstance(res_json[0], dict):
            run_id = res_json[0].get("run_id") or res_json[0].get("id")
            result_obj = res_json[0].get("result") or {}

    # Ensure result is a dict
    if not isinstance(result_obj, dict):
        result_obj = {"value": result_obj}

    return run_id, result_obj


def _clear_qp():
    """Clear query params (modern Streamlit API)."""
    try:
        st.query_params.clear()
    except Exception:
        pass


def load_image(base: str) -> Optional[str]:
    for ext in [".png", ".jpg", ".jpeg", ".webp", ".gif", ".svg"]:
        p = os.path.join(LANDING_IMG_DIR, f"{base}{ext}")
        if os.path.exists(p):
            return p
    return None


def save_uploaded_image(uploaded_file, base: str):
    if not uploaded_file:
        return None
    ext = os.path.splitext(uploaded_file.name)[1].lower() or ".png"
    dest = os.path.join(LANDING_IMG_DIR, f"{base}{ext}")
    with open(dest, "wb") as f:
        f.write(uploaded_file.getvalue())
    return dest


def render_image_tag(agent_id: str, industry: str, emoji_fallback: str) -> str:
    base = agent_id.lower().replace(" ", "_")
    img_path = load_image(base) or load_image(industry.replace(" ", "_"))
    if img_path:
        return (
            f'<img src="file://{img_path}" '
            f'style="width:48px;height:48px;border-radius:10px;object-fit:cover;">'
        )
    return f'<div style="font-size:32px;">{emoji_fallback}</div>'





# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# DATA
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
AGENTS = [
    ("ğŸ¦ Banking & Finance", "ğŸ’° Retail Banking", "ğŸ’³ Credit Appraisal Agent",
     "Explainable AI for loan decisioning", "Available", "ğŸ’³"),
    ("ğŸ¦ Banking & Finance", "ğŸ’° Retail Banking", "ğŸ¦ Asset Appraisal Agent",
     "Market-driven collateral valuation", "Available", "ğŸ¦"),
    ("ğŸ¦ Banking & Finance", "ğŸ›¡ï¸ Compliance", "ğŸ›¡ï¸ Anti-Fraud & KYC Agent",
     "Streamlined onboarding with fraud scoring", "Available", "ğŸ›¡ï¸"),
    ("ğŸ¦ Banking & Finance", "ğŸ©º Insurance", "ğŸ©º Claims Triage Agent",
     "Automated claims prioritization", "Coming Soon", "ğŸ©º"),
    ("âš¡ Energy & Sustainability", "ğŸ”‹ EV & Charging", "âš¡ EV Charger Optimizer",
     "Optimize charger deployment via AI", "Coming Soon", "âš¡"),
    ("âš¡ Energy & Sustainability", "â˜€ï¸ Solar", "â˜€ï¸ Solar Yield Estimator",
     "Estimate solar ROI and efficiency", "Coming Soon", "â˜€ï¸"),
    ("ğŸš— Automobile & Transport", "ğŸš™ Automobile", "ğŸš— Predictive Maintenance",
     "Prevent downtime via sensor analytics", "Coming Soon", "ğŸš—"),
    ("ğŸš— Automobile & Transport", "ğŸ”‹ EV", "ğŸ”‹ EV Battery Health Agent",
     "Monitor EV battery health cycles", "Coming Soon", "ğŸ”‹"),
    ("ğŸš— Automobile & Transport", "ğŸšš Ride-hailing / Logistics", "ğŸ›» Fleet Route Optimizer",
     "Dynamic route optimization for fleets", "Coming Soon", "ğŸ›»"),
    ("ğŸ’» Information Technology", "ğŸ§° Support & Security", "ğŸ§© IT Ticket Triage",
     "Auto-prioritize support tickets", "Coming Soon", "ğŸ§©"),
    ("ğŸ’» Information Technology", "ğŸ›¡ï¸ Security", "ğŸ” SecOps Log Triage",
     "Detect anomalies & summarize alerts", "Coming Soon", "ğŸ”"),
    ("âš–ï¸ Legal & Government", "âš–ï¸ Law Firms", "âš–ï¸ Contract Analyzer",
     "Extract clauses and compliance risks", "Coming Soon", "âš–ï¸"),
    ("âš–ï¸ Legal & Government", "ğŸ›ï¸ Public Services", "ğŸ›ï¸ Citizen Service Agent",
     "Smart assistant for citizen services", "Coming Soon", "ğŸ›ï¸"),
    ("ğŸ›ï¸ Retail / SMB / Creative", "ğŸ¬ Retail & eCommerce", "ğŸ“ˆ Sales Forecast Agent",
     "Predict demand & inventory trends", "Coming Soon", "ğŸ“ˆ"),
    ("ğŸ¬ Retail / SMB / Creative", "ğŸ¨ Media & Film", "ğŸ¬ Budget Cost Assistant",
     "Estimate, optimize, and track film & production costs using AI", "Coming Soon", "ğŸ¬"),
]




# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # STYLES
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

st.markdown(
    """
    <style>
    html, body, .block-container { background-color:#0f172a !important; color:#e2e8f0 !important; }
    footer { text-align:center; padding:2rem; color:#aab3c2; font-size:1.2rem; font-weight:600; margin-top:2rem; }
    .left-box {
        background: radial-gradient(circle at top left, #0f172a, #1e293b);
        border-radius:20px; padding:3rem 2rem; color:#f1f5f9; box-shadow:6px 0 24px rgba(0,0,0,0.4);
    }
    .right-box {
        background:linear-gradient(180deg,#1e293b,#0f172a);
        border-radius:20px; padding:2rem; box-shadow:-6px 0 24px rgba(0,0,0,0.35);
    }
    .stButton > button {
        border:none !important; cursor:pointer;
        padding:14px 28px !important; font-size:18px !important; font-weight:700 !important;
        border-radius:14px !important; color:#fff !important;
        background:linear-gradient(180deg,#4ea3ff 0%,#2f86ff 60%,#0f6fff 100%) !important;
        box-shadow:0 8px 24px rgba(15,111,255,0.35);
    }
    a.macbtn {
        display:inline-block; text-decoration:none !important; color:#fff !important;
        padding:10px 22px; font-weight:700; border-radius:12px;
        background:linear-gradient(180deg,#4ea3ff 0%,#2f86ff 60%,#0f6fff 100%);
    }
    /* Larger workflow tabs */
    [data-testid="stTabs"] [data-baseweb="tab"] {
        font-size: 28px !important;
        font-weight: 800 !important;
        padding: 20px 40px !important;
        border-radius: 12px !important;
        background-color: #1e293b !important;
        color: #f8fafc !important;
    }
    [data-testid="stTabs"] [data-baseweb="tab"][aria-selected="true"] {
        background: linear-gradient(90deg, #2563eb, #1d4ed8) !important;
        color: white !important;
        border-bottom: 6px solid #60a5fa !important;
        box-shadow: 0 4px 14px rgba(37,99,235,0.5);
    }

    /* ---------------- NEW: hover/focus polish ---------------- */
    /* Hover/active for buttons */
    .stButton > button:hover { filter: brightness(1.06); transform: translateY(-1px); }
    .stButton > button:active { transform: translateY(0); box-shadow: 0 4px 12px rgba(15,111,255,0.35); }

    /* Subtle hover for tabs */
    [data-testid="stTabs"] [data-baseweb="tab"][role="tab"]:hover {
      box-shadow: 0 6px 18px rgba(37,99,235,0.35);
    }

    /* Improve link focus visibility (a11y) */
    a:focus { outline: 3px solid #60a5fa !important; outline-offset: 2px; border-radius: 6px; }
    /* --------------------------------------------------------- */
    </style>
    """,
    unsafe_allow_html=True,
)


# st.markdown(
#     """
#     <style>
#     html, body, .block-container { background-color:#0f172a !important; color:#e2e8f0 !important; }
#     footer { text-align:center; padding:2rem; color:#aab3c2; font-size:1.2rem; font-weight:600; margin-top:2rem; }
#     .left-box {
#         background: radial-gradient(circle at top left, #0f172a, #1e293b);
#         border-radius:20px; padding:3rem 2rem; color:#f1f5f9; box-shadow:6px 0 24px rgba(0,0,0,0.4);
#     }
#     .right-box {
#         background:linear-gradient(180deg,#1e293b,#0f172a);
#         border-radius:20px; padding:2rem; box-shadow:-6px 0 24px rgba(0,0,0,0.35);
#     }
#     .stButton > button {
#         border:none !important; cursor:pointer;
#         padding:14px 28px !important; font-size:18px !important; font-weight:700 !important;
#         border-radius:14px !important; color:#fff !important;
#         background:linear-gradient(180deg,#4ea3ff 0%,#2f86ff 60%,#0f6fff 100%) !important;
#         box-shadow:0 8px 24px rgba(15,111,255,0.35);
#     }
#     a.macbtn {
#         display:inline-block; text-decoration:none !important; color:#fff !important;
#         padding:10px 22px; font-weight:700; border-radius:12px;
#         background:linear-gradient(180deg,#4ea3ff 0%,#2f86ff 60%,#0f6fff 100%);
#     }
#     /* Larger workflow tabs */
#     [data-testid="stTabs"] [data-baseweb="tab"] {
#         font-size: 28px !important;
#         font-weight: 800 !important;
#         padding: 20px 40px !important;
#         border-radius: 12px !important;
#         background-color: #1e293b !important;
#         color: #f8fafc !important;
#     }
#     [data-testid="stTabs"] [data-baseweb="tab"][aria-selected="true"] {
#         background: linear-gradient(90deg, #2563eb, #1d4ed8) !important;
#         color: white !important;
#         border-bottom: 6px solid #60a5fa !important;
#         box-shadow: 0 4px 14px rgba(37,99,235,0.5);
#     }
#     </style>
#     """,
#     unsafe_allow_html=True,
# )

# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # QUERY PARAM ROUTING (modern API)
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# try:
#     qp = st.query_params
# except Exception:
#     qp = {}

# if "stage" in qp:
#     target = qp["stage"]
#     # Add "asset_agent" here so it's recognized
#     if target in {"landing", "agents", "login", "credit_agent", "asset_agent"} and st.session_state.stage != target:
#         st.session_state.stage = target
#         _clear_qp()
#         st.rerun()

# # Handle direct launch requests for specific agents
# if "launch" in qp or "agent" in qp:
#     agent = qp.get("agent", [""])[0] if isinstance(qp.get("agent"), list) else qp.get("agent", "")
#     if agent == "credit":
#         st.session_state.stage = "login"
#     elif agent == "asset":
#         st.session_state.stage = "asset_agent"
#     _clear_qp()
#     st.rerun()


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# QUERY PARAM ROUTING (agent first, then stage)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
try:
    qp = st.query_params
except Exception:
    qp = {}

# 1) Agent intent wins (direct actions)
if "launch" in qp or "agent" in qp:
    agent = qp.get("agent", [""])[0] if isinstance(qp.get("agent"), list) else qp.get("agent", "")
    if agent == "credit":
        st.session_state.stage = "login"
        _clear_qp()
        st.rerun()
    elif agent == "asset":
        _clear_qp()
        # Go straight to the Asset page (no extra reroute hops)
        try:
            st.switch_page("pages/asset_appraisal.py")
        except Exception as e:
            # Fallback: set stage so user stays in same app gracefully
            st.session_state.stage = "asset_agent"
            st.warning(f"Could not switch to asset page, stage set to asset_agent: {e}")
            st.rerun()
    elif agent in {"anti_fraud", "afk", "kyc"}:
        _clear_qp()
        try:
            st.switch_page("pages/anti_fraud_kyc.py")
        except Exception as e:
            st.warning(f"Could not open anti-fraud agent page: {e}")
            st.session_state.stage = "landing"
            st.rerun()

# 2) Stage param (secondary)
if "stage" in qp:
    target = qp["stage"]
    if target in {"landing", "agents", "login", "credit_agent", "asset_agent"} and st.session_state.stage != target:
        st.session_state.stage = target
        _clear_qp()
        st.rerun()



# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STAGE: LANDING
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import base64
import os
import json
import streamlit as st

# Ensure sidebar is never rendered
st.set_page_config(page_title="AI Sandbox â€” By the People", layout="wide", initial_sidebar_state="collapsed")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ’¡ FORCE REMOVE SIDEBAR ENTIRELY
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
    <style>
    [data-testid="stSidebar"], section[data-testid="stSidebar"] {
        display: none !important;
    }
    [data-testid="stAppViewContainer"] {
        margin-left: 0 !important;
        padding-left: 0 !important;
    }
    </style>
""", unsafe_allow_html=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# INITIALIZE SESSION STATE
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "stage" not in st.session_state:
    st.session_state.stage = "landing"
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# DEFINE PATHS + FILES
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
FEEDBACK_FILE = os.path.join(BASE_DIR, "agents_feedback.json")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# FEEDBACK LOADING + CACHE
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def load_feedback() -> dict:
    """Load feedback data (ratings, users, comments) from JSON file."""
    try:
        with open(FEEDBACK_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except Exception:
        return {}

def render_stars(rating: float) -> str:
    """Render gold stars for rating."""
    full = int(round(rating))
    return "".join(
        [f"<span style='color:gold;font-size:18px;'>â˜…</span>" for _ in range(full)]
        + [f"<span style='color:#334155;font-size:18px;'>â˜…</span>" for _ in range(5 - full)]
    )

# Cache feedback across tabs (Landing + Feedback)
feedback_data = st.session_state.get("feedback_data") or load_feedback()
st.session_state["feedback_data"] = feedback_data

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PAGE: LANDING
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if st.session_state.stage == "landing":



    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Layout columns
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    c1, c2 = st.columns([1.1, 1.9], gap="large")

    # LEFT PANEL
    with c1:
        st.markdown("<div class='left-box'>", unsafe_allow_html=True)

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # HERO LOGO â€” Double-click to upload
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        logo_dir = os.path.join(BASE_DIR, "assets")
        os.makedirs(logo_dir, exist_ok=True)
        saved_logo_path = os.path.join(logo_dir, "uploaded_logo.png")

        st.markdown("""
            <script>
            function openLogoUploader() {
                const uploader = document.querySelector('input[data-testid="stFileUploadDropzoneInput"]');
                if (uploader) uploader.click();
            }
            </script>
        """, unsafe_allow_html=True)

        if os.path.exists(saved_logo_path):
            with open(saved_logo_path, "rb") as f:
                logo_base64 = base64.b64encode(f.read()).decode()
            st.markdown(
                f"""
                <div ondblclick="openLogoUploader()" style="cursor:pointer; text-align:center;">
                    <img src="data:image/png;base64,{logo_base64}" width="220">
                    <p style="font-size:12px;color:#94a3b8;">Double-click logo to replace</p>
                </div>
                """,
                unsafe_allow_html=True,
            )
        else:
            st.markdown(
                """
                <div ondblclick="openLogoUploader()" style="cursor:pointer; text-align:center;
                     width:240px;height:100px;border:2px dashed #334155;border-radius:12px;">
                     <p style="padding-top:36px;color:#64748b;">Double-click to upload logo</p>
                </div>
                """,
                unsafe_allow_html=True,
            )

        uploaded_logo = st.file_uploader(
            "Upload new logo",
            type=["png", "jpg", "jpeg", "webp"],
            key="upload_logo_hidden",
            label_visibility="collapsed",
        )
        if uploaded_logo is not None:
            with open(saved_logo_path, "wb") as f:
                f.write(uploaded_logo.read())
            st.success("âœ… Logo updated!")
            st.rerun()



        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # HERO + FOUNDATIONAL MESSAGE
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        st.markdown(
            """
            <h1 style="font-size:38px; font-weight:800;">ğŸš€ Together, Letâ€™s Build an AI Foundry â€” by the People, for the People</h1>
            <h3 style="font-size:28px; font-weight:700; color:#38bdf8;">âš™ï¸ Open AI Agent Sandbox â€” From Idea to Production</h3>

            <p style="font-size:18px; line-height:1.8;">
            <span style="font-size:26px; font-weight:800; color:#60a5fa;">What:</span><br>
            The <b>Open AI Agent Sandbox</b> is a <b>Foundry</b> where your AI ideas become reality â€”
            turning imagination into explainable, open, and living agents.
            </p>

            <p style="font-size:18px; line-height:1.8;">
            <span style="font-size:26px; font-weight:800; color:#60a5fa;">So What:</span><br>
            No CAPEX. No gatekeepers. Just <b>GPU-for-Rent power</b>, <b>open-source models</b>, and <b>privacy-first design</b>.
            Build faster, own your data, and innovate without limits.
            </p>

            <p style="font-size:18px; line-height:1.8;">
            <span style="font-size:26px; font-weight:800; color:#60a5fa;">How:</span><br>
            Start with a <b>ready-to-use AI Agent Template</b> â€” customize, test, improve,
            and export when itâ€™s production-ready.
            </p>

            <p style="font-size:18px; line-height:1.8;">
            <span style="font-size:26px; font-weight:800; color:#60a5fa;">Where:</span><br>
            All inside your <b>GPU-for-Rent Cloud Sandbox</b> â€”
            a secure, sovereign forge where ideas ignite and models evolve.
            </p>

            <p style="font-size:18px; line-height:1.8;">
            <span style="font-size:26px; font-weight:800; color:#60a5fa;">For Who:</span><br>
            For builders, dreamers, educators, and enterprises who believe
            AI should empower the many, not the few.
            </p>

            <p style="font-size:18px; line-height:1.8;">
            <span style="font-size:26px; font-weight:800; color:#60a5fa;">What Now:</span><br>
            Bring your spark. Shape your agent. Forge your legacy.<br>
            <b>Your AI idea â†’ Production-ready Reality.</b>
            </p>
            """,
            unsafe_allow_html=True,
        )

        # CTA
        if st.button("ğŸ”¥ Start Building Now", key="btn_start_build_now"):
            st.session_state.stage = "agents"
            st.rerun()

        st.markdown("</div>", unsafe_allow_html=True)


    # RIGHT PANEL â€” Neon Interactive Agent List 
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    with c2:
        # Inject CSS once
        st.markdown("""
        <style>
        @keyframes pulseFrame {
            0%,100% { box-shadow: 0 0 35px rgba(0,200,255,0.25), inset 0 0 15px rgba(0,200,255,0.25); }
            50% { box-shadow: 0 0 90px rgba(0,240,255,0.7), inset 0 0 25px rgba(0,240,255,0.45); }
        }

        .neon-frame {
            border: 2px solid rgba(0,200,255,0.6);
            border-radius: 18px;
            padding: 1.5rem;
            margin-top: 1rem;
            margin-bottom: 2rem;
            background: linear-gradient(180deg, rgba(8,17,30,0.95), rgba(10,25,45,0.95));
            animation: pulseFrame 6s ease-in-out infinite;
            box-shadow: 0 0 60px rgba(0,200,255,0.35);
        }

        .agent-card {
            border: 1px solid rgba(0,200,255,0.3);
            border-radius: 10px;
            padding: 0.8rem 1.2rem;
            margin: 0.6rem 0;
            background: rgba(15,25,35,0.85);
            transition: transform 0.25s ease-in-out, box-shadow 0.25s ease-in-out;
        }

        .agent-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 25px rgba(0,240,255,0.5);
        }

        .neon-header {
            background: linear-gradient(90deg, #ff0033, #ff3366);
            border-radius: 8px;
            color: white;
            font-weight: 700;
            padding: 8px 14px;
            margin-bottom: 14px;
            text-align: center;
            text-shadow: 0 0 8px rgba(255,80,100,0.9);
            box-shadow: 0 0 20px rgba(255,60,100,0.6);
            font-size: 1.6rem;
        }

        .launchbtn {
            display: inline-block;
            text-decoration: none;
            color: #e6f7ff;
            font-weight: 700;
            padding: 6px 16px;
            border-radius: 8px;
            border: 1px solid rgba(0,220,255,0.8);
            background: rgba(0,50,80,0.5);
            box-shadow: 0 0 14px rgba(0,220,255,0.5);
            transition: all 0.25s ease-in-out;
        }

        .launchbtn:hover {
            box-shadow: 0 0 25px rgba(255,105,180,0.8);
            transform: translateY(-2px) scale(1.05);
            text-shadow: 0 0 12px #ff66cc;
        }
        </style>
        """, unsafe_allow_html=True)

        # ============================================================
        # Build all agent HTML dynamically into one single string
        # ============================================================
        import re

        html_agents = ""
        for sector, industry, agent, desc, status, emoji in AGENTS:
            # ----- status color mapping -----
            if status == "Available":
                status_label = "âœ… Available"; status_color = "#22c55e"
            elif status == "Coming Soon":
                status_label = "â³ Coming Soon"; status_color = "#f59e0b"
            else:
                status_label = status; status_color = "#f1f5f9"

            # ----- feedback / usage data -----
            fb = feedback_data.get(agent, {"rating": 0, "users": 0, "comments": []})
            users = fb.get("users", 0)
            comment_count = len(fb.get("comments", []))

            # ----- build clean route name -----
            clean_agent = re.sub(r"[^\w\s-]", "", agent).strip().lower()  # remove emojis/symbols
            route_name = clean_agent.replace(" ", "_").replace("_agent", "")  # shorten URL
            launch_url = f"/{route_name}"

            # ----- append HTML for this agent card -----
            html_agents += f"""
            <div class="agent-card">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
                    <div style="flex:1.2;color:#ccc;">{industry}</div>
                    <div style="flex:1.5;font-weight:700;color:white;">{agent}</div>
                    <div style="flex:3;color:#a0aec0;">{desc}</div>
                    <div style="flex:1;text-align:center;color:{status_color};font-weight:700;">{status_label}</div>
                    <div style="flex:0.6;text-align:center;">ğŸ‘¥ {users}</div>
                    <div style="flex:0.6;text-align:center;">ğŸ’¬ {comment_count}</div>
                    <div style="flex:0.8;text-align:center;">
                        <a class="launchbtn" href="{launch_url}">ğŸš€ Launch</a>
                    </div>
                </div>
            </div>
            """

        # ============================================================
        # Render all at once (HTML, not escaped Markdown)
        # ============================================================
        st.markdown(
            f"""
            <div class="neon-header">ğŸ“Š Global AI Agent Library</div>
            <div class="neon-frame">
                {html_agents}
            </div>
            <footer style="text-align:center;margin-top:2rem;color:#a3e8ff;">
                ğŸ’ Made with â¤ï¸ by Dzoan Nguyen â€” Open AI Sandbox Initiative
            </footer>
            """,
            unsafe_allow_html=True
        )

        st.stop()

        
        # # Build all agent HTML dynamically into one single string
        # html_agents = ""
        # for sector, industry, agent, desc, status, emoji in AGENTS:
        #     if status == "Available":
        #         status_label = "âœ… Available"; status_color = "#22c55e"
        #     elif status == "Coming Soon":
        #         status_label = "â³ Coming Soon"; status_color = "#f59e0b"
        #     else:
        #         status_label = status; status_color = "#f1f5f9"

        #     fb = feedback_data.get(agent, {"rating": 0, "users": 0, "comments": []})
        #     users = fb.get("users", 0)
        #     comment_count = len(fb.get("comments", []))

        #     html_agents += f"""
        #     <div class="agent-card">
        #         <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
        #             <div style="flex:1.2;color:#ccc;">{industry}</div>
        #             <div style="flex:1.5;font-weight:700;color:white;">{agent}</div>
        #             <div style="flex:3;color:#a0aec0;">{desc}</div>
        #             <div style="flex:1;text-align:center;color:{status_color};font-weight:700;">{status_label}</div>
        #             <div style="flex:0.6;text-align:center;">ğŸ‘¥ {users}</div>
        #             <div style="flex:0.6;text-align:center;">ğŸ’¬ {comment_count}</div>
        #             <div style="flex:0.8;text-align:center;">
        #                 <a class="launchbtn" href="?agent={agent.lower().replace(' ','_')}&stage=login">ğŸš€ Launch</a>
        #             </div>
        #         </div>
        #     </div>
        #     """

        # # Render all at once (HTML, not escaped Markdown)
        # st.markdown(
        #     f"""
        #     <div class="neon-header">ğŸ“Š Global AI Agent Library</div>
        #     <div class="neon-frame">
        #         {html_agents}
        #     </div>
        #     <footer style="text-align:center;margin-top:2rem;color:#a3e8ff;">
        #         ğŸ’ Made with â¤ï¸ by Dzoan Nguyen â€” Open AI Sandbox Initiative
        #     </footer>
        #     """,
        #     unsafe_allow_html=True  # â† this must be TRUE so HTML isn't escaped
        # )

        # st.stop()

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # # RIGHT PANEL â€” Neon Interactive Agent List
    # # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # with c2:
    #     # Inject Neon CSS
    #     st.markdown("""
    #     <style>
    #     @keyframes pulseOuter {
    #         0%,100% { box-shadow: 0 0 35px rgba(0,200,255,0.3), inset 0 0 15px rgba(0,200,255,0.3); }
    #         50% { box-shadow: 0 0 90px rgba(0,240,255,0.8), inset 0 0 25px rgba(0,240,255,0.5); }
    #     }

    #     .neon-card {
    #         border: 2px solid rgba(0,200,255,0.6);
    #         border-radius: 14px;
    #         padding: 1rem 1.5rem;
    #         margin: 1.2rem 0;
    #         background: linear-gradient(180deg, rgba(8,17,30,0.95), rgba(10,25,45,0.95));
    #         animation: pulseOuter 6s ease-in-out infinite;
    #         box-shadow: 0 0 60px rgba(0,200,255,0.35);
    #         transition: transform 0.25s ease-in-out;
    #     }

    #     .neon-card:hover {
    #         transform: translateY(-4px) scale(1.01);
    #         box-shadow: 0 0 90px rgba(0,240,255,0.6);
    #     }

    #     .neon-header {
    #         background: linear-gradient(90deg, #ff0033, #ff3366);
    #         border-radius: 8px;
    #         color: white;
    #         font-weight: 700;
    #         padding: 8px 14px;
    #         margin-bottom: 10px;
    #         text-shadow: 0 0 8px rgba(255,80,100,0.9);
    #         box-shadow: 0 0 20px rgba(255,60,100,0.6);
    #     }

    #     .launchbtn {
    #         display: inline-block;
    #         text-decoration: none;
    #         color: #e6f7ff;
    #         font-weight: 700;
    #         padding: 6px 16px;
    #         border-radius: 8px;
    #         border: 1px solid rgba(0,220,255,0.8);
    #         background: rgba(0,50,80,0.5);
    #         box-shadow: 0 0 14px rgba(0,220,255,0.5);
    #         transition: all 0.25s ease-in-out;
    #     }

    #     .launchbtn:hover {
    #         box-shadow: 0 0 25px rgba(255,105,180,0.8);
    #         transform: translateY(-2px) scale(1.05);
    #         text-shadow: 0 0 12px #ff66cc;
    #     }

    #     </style>
    #     """, unsafe_allow_html=True)

    #     # Header
    #     st.markdown("<div class='neon-header' style='text-align:center;font-size:1.6rem;'>ğŸ“Š Global AI Agent Library</div>", unsafe_allow_html=True)

    #     # Agent cards
    #     for sector, industry, agent, desc, status, emoji in AGENTS:
    #         if status == "Available":
    #             status_label = "âœ… Available"
    #             status_color = "#22c55e"
    #         elif status == "Coming Soon":
    #             status_label = "â³ Coming Soon"
    #             status_color = "#f59e0b"
    #         else:
    #             status_label = status
    #             status_color = "#f1f5f9"

    #         fb = feedback_data.get(agent, {"rating": 0, "users": 0, "comments": []})
    #         rating_html = render_stars(fb.get("rating", 0))
    #         users = fb.get("users", 0)
    #         comments = fb.get("comments", [])
    #         comment_count = len(comments)

    #         # Neon card per agent
    #         st.markdown("<div class='neon-card'>", unsafe_allow_html=True)
    #         cols = st.columns([1.0, 1.4, 2.8, 1.0, 0.8, 0.9, 1.0])

    #         with cols[0]:
    #             st.markdown(f"{industry}")
    #         with cols[1]:
    #             st.markdown(f"**{agent}**")
    #         with cols[2]:
    #             st.markdown(desc)
    #         with cols[3]:
    #             st.markdown(f"<span style='color:{status_color};font-weight:700;'>{status_label}</span>", unsafe_allow_html=True)
    #         with cols[4]:
    #             st.markdown(f"ğŸ‘¥ {users}")
    #         with cols[5]:
    #             if comment_count > 0:
    #                 if st.button(f"ğŸ’¬ {comment_count}", key=f"btn_{agent}"):
    #                     st.session_state[f"show_comments_{agent}"] = not st.session_state.get(f"show_comments_{agent}", False)
    #             else:
    #                 st.markdown("ğŸ’¬ 0")
    #         with cols[6]:
    #             st.markdown(
    #                 f"<a class='launchbtn' href='?agent={agent.lower().replace(' ','_')}&stage=login'>ğŸš€ Launch</a>",
    #                 unsafe_allow_html=True
    #             )

    #         # Comments expander
    #         if st.session_state.get(f"show_comments_{agent}", False):
    #             with st.expander(f"ğŸ—£ Comments for {agent}", expanded=True):
    #                 if comments:
    #                     for cmt in reversed(comments):
    #                         st.markdown(f"- {cmt}")
    #                 else:
    #                     st.markdown("_No comments yet._")

    #         st.markdown("</div>", unsafe_allow_html=True)

    #     # Footer
    #     st.markdown("<footer style='text-align:center;margin-top:2rem;color:#a3e8ff;'>ğŸ’ Made with â¤ï¸ by Dzoan Nguyen â€” Open AI Sandbox Initiative</footer>", unsafe_allow_html=True)
    #     st.stop()


    # # Right Panel
    # with c2:
    #     st.markdown("<div class='right-box'>", unsafe_allow_html=True)
    #     st.markdown("<h2>ğŸ“Š Global AI Agent Library</h2>", unsafe_allow_html=True)

    #     for sector, industry, agent, desc, status, emoji in AGENTS:
    #         # âœ… Revert to original Available / Coming Soon logic
    #         if status == "Available":
    #             status_label = "Available"
    #             status_color = "#22c55e"   # green
    #         elif status == "Coming Soon":
    #             status_label = "Coming Soon"
    #             status_color = "#f59e0b"   # orange
    #         else:
    #             status_label = status
    #             status_color = "#f1f5f9"

    #         fb = feedback_data.get(agent, {"rating": 0, "users": 0, "comments": []})
    #         rating_html = render_stars(fb.get("rating", 0))
    #         users = fb.get("users", 0)
    #         comments = fb.get("comments", [])
    #         comment_count = len(comments)

    #         cols = st.columns([0.5, 1.0, 1.4, 2.8, 1.0, 0.8, 0.9, 1.0])
    #         with cols[0]:
    #             st.markdown(render_image_tag(agent, industry, emoji), unsafe_allow_html=True)
    #         with cols[1]:
    #             st.markdown(f"**{industry}**")
    #         with cols[2]:
    #             st.markdown(f"**{agent}**")
    #         with cols[3]:
    #             st.markdown(desc)
    #         with cols[4]:
    #             st.markdown(rating_html, unsafe_allow_html=True)
    #         with cols[5]:
    #             st.markdown(f"ğŸ‘¥ {users}")
    #         with cols[6]:
    #             if comment_count > 0:
    #                 if st.button(f"ğŸ’¬ {comment_count}", key=f"btn_{agent}"):
    #                     st.session_state[f"show_comments_{agent}"] = not st.session_state.get(
    #                         f"show_comments_{agent}", False
    #                     )
    #             else:
    #                 st.markdown("ğŸ’¬ 0")
    #         with cols[7]:
    #             st.markdown(
    #                 f"<span style='color:{status_color};font-weight:700;'>{status_label}</span>",
    #                 unsafe_allow_html=True,
    #             )

    #         if st.session_state.get(f"show_comments_{agent}", False):
    #             with st.expander(f"ğŸ—£ Comments for {agent}", expanded=True):
    #                 for cmt in reversed(comments):
    #                     st.markdown(f"- {cmt}")

    #         st.markdown("---")

    #     st.markdown("</div>", unsafe_allow_html=True)

    # st.markdown("<footer>Made with â¤ï¸ by Dzoan Nguyen â€” Open AI Sandbox Initiative</footer>", unsafe_allow_html=True)
    # st.stop()


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STAGE: AGENTS (Neon Styled)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if st.session_state.stage == "agents":
    # Inject CSS once
    st.markdown("""
    <style>
    @keyframes pulseFrame {
        0%,100% { box-shadow: 0 0 35px rgba(0,200,255,0.25), inset 0 0 15px rgba(0,200,255,0.25); }
        50% { box-shadow: 0 0 90px rgba(0,240,255,0.7), inset 0 0 25px rgba(0,240,255,0.45); }
    }

    .neon-frame {
        border: 2px solid rgba(0,200,255,0.6);
        border-radius: 18px;
        padding: 2rem;
        margin: 1rem 0 3rem 0;
        background: linear-gradient(180deg, rgba(8,17,30,0.95), rgba(10,25,45,0.95));
        animation: pulseFrame 6s ease-in-out infinite;
        box-shadow: 0 0 60px rgba(0,200,255,0.35);
    }

    .neon-header {
        background: linear-gradient(90deg, #ff0033, #ff3366);
        border-radius: 8px;
        color: white;
        font-weight: 700;
        padding: 10px 20px;
        text-align: center;
        text-shadow: 0 0 8px rgba(255,80,100,0.9);
        box-shadow: 0 0 20px rgba(255,60,100,0.6);
        font-size: 1.6rem;
        margin-bottom: 1.5rem;
    }

    .neon-table {
        width: 100%;
        border-collapse: collapse;
    }
    .neon-table th, .neon-table td {
        padding: 10px 16px;
        border-bottom: 1px solid rgba(0,200,255,0.3);
        color: #e2e8f0;
        text-align: left;
    }
    .neon-table th {
        color: #7dd3fc;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.9rem;
    }

    .macbtn {
        text-decoration: none;
        color: #e6f7ff;
        font-weight: 700;
        padding: 6px 16px;
        border-radius: 8px;
        border: 1px solid rgba(0,220,255,0.8);
        background: rgba(0,50,80,0.5);
        box-shadow: 0 0 14px rgba(0,220,255,0.5);
        transition: all 0.25s ease-in-out;
        display: inline-block;
    }
    .macbtn:hover {
        box-shadow: 0 0 25px rgba(255,105,180,0.8);
        transform: translateY(-2px) scale(1.05);
        text-shadow: 0 0 12px #ff66cc;
    }
    </style>
    """, unsafe_allow_html=True)

    # Header section
    st.markdown("<div class='neon-header'>ğŸ¤– Available AI Agents</div>", unsafe_allow_html=True)

    # Data
    df = pd.DataFrame([
        {"Agent": "ğŸ’³ Credit Appraisal Agent",
         "Description": "Explainable AI for retail loan decisioning",
         "Status": "âœ… Available",
         "Action": '<a class="macbtn" href="/credit_appraisal">ğŸš€ Launch</a>'},
        {"Agent": "ğŸ¦ Asset Appraisal Agent",
         "Description": "Market-driven collateral valuation",
         "Status": "âœ… Available",
         "Action": '<a class="macbtn" href="/asset_appraisal">ğŸš€ Launch</a>'},
        {"Agent": "ğŸ›¡ï¸ Anti-Fraud & KYC Agent",
         "Description": "Onboard customers with automated KYC",
         "Status": "âœ… Available",
         "Action": '<a class="macbtn" href="/anti_fraud_kyc">ğŸš€ Launch</a>'},
    ])

    # Neon table frame
    html_table = df.to_html(escape=False, index=False, classes="neon-table")
    st.markdown(f"<div class='neon-frame'>{html_table}</div>", unsafe_allow_html=True)

    # Footer
    st.markdown(
        "<footer style='text-align:center;margin-top:1rem;color:#a3e8ff;'>"
        "ğŸ’ Made with â¤ï¸ by Dzoan Nguyen â€” Open AI Sandbox Initiative</footer>",
        unsafe_allow_html=True
    )

    st.stop()




# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # STAGE: AGENTS boring
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# if st.session_state.stage == "agents":
#     top = st.columns([1, 6, 1])
#     with top[1]:
#         st.title("ğŸ¤– Available AI Agents")

#     df = pd.DataFrame([
#         {"Agent": "ğŸ’³ Credit Appraisal Agent",
#          "Description": "Explainable AI for retail loan decisioning",
#          "Status": "âœ… Available",
#          "Action": '<a class="macbtn" href="?agent=credit&stage=login">ğŸš€ Launch</a>'},
#         {"Agent": "ğŸ¦ Asset Appraisal Agent",
#          "Description": "Market-driven collateral valuation",
#          "Status": "âœ… Available",
#          "Action": '<a class="macbtn" href="?agent=asset&stage=asset_agent">ğŸš€ Launch</a>'},
#     ])
#     st.write(df.to_html(escape=False, index=False), unsafe_allow_html=True)
#     st.markdown(
#         "<footer>Made with â¤ï¸ by Dzoan Nguyen â€” Open AI Sandbox Initiative</footer>",
#         unsafe_allow_html=True
#     )
#     st.stop()


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STAGE: LOGIN
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if st.session_state.stage == "login":
    # top = st.columns([1, 4, 1])
    # with top[0]:
    #     if st.button("â¬…ï¸ Back to Agents", key="btn_back_agents_from_login"):
    #         st.session_state.stage = "agents"
    #         st.rerun()
    # with top[1]:
    #     st.title("ğŸ” Login to AI Credit Appraisal Platform")
    top = st.columns([1, 4, 1])
    with top[1]:
        st.title("ğŸ” Login to AI Credit Appraisal Platform")

    c1, c2, c3 = st.columns([1, 1, 1])
    with c1:
        user = st.text_input("Username", placeholder="e.g. dzoan")
    with c2:
        email = st.text_input("Email", placeholder="e.g. dzoan@demo.local")
    with c3:
        pwd = st.text_input("Password", type="password", placeholder="Enter any password")
    if st.button("Login", key="btn_login_submit", use_container_width=True):
        if user.strip() and email.strip():
            st.session_state.user_info = {
                "name": user.strip(),
                "email": email.strip(),
                "flagged": False,
                "timestamp": datetime.now(timezone.utc).isoformat()
            }
            st.session_state.logged_in = True
            st.session_state.stage = "credit_agent"
            st.rerun()
        else:
            st.error("âš ï¸ Please fill all fields before continuing.")
    st.markdown("<footer>Made with â¤ï¸ by Dzoan Nguyen â€” Open AI Sandbox Initiative</footer>", unsafe_allow_html=True)
    st.stop()



#


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STAGE: ASSET WORKFLOW (redirect to page)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if  st.session_state.stage == "asset_agent":
    try:
        st.switch_page("pages/asset_appraisal.py")
    except Exception as e:
        st.error(f"Could not switch to asset appraisal page: {e}")
        st.info("Ensure file exists at services/ui/pages/asset_appraisal.py")
